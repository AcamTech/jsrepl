(function(){var d,n,p,a,g,r,j,c,q,e,l,s,f,o,m,h,i,k;var b=function(t,u){return function(){return t.apply(u,arguments)}};d=jQuery;h=0;i=1;k=2;e=13;o=9;j=46;r=8;s=37;f=39;m=38;c=40;l=36;q=35;a=">>> ";p="... ";n=2;g=(function(){function t(u,x,v,w){this.header=x||"";this.prompt_label_main=v||a;this.prompt_label_continue="\n"+(w||p);this.indent_width=n;this.state=i;this.input_queue=[];this.input_callback=null;this.multiline_callback=null;this.history=[];this.history_index=0;this.history_new="";this.history_active=false;this.shortcuts={};this.$console=d('<pre class="jqconsole"/>').appendTo(u);this.$input_source=d("<textarea/>");this.$input_source.css({position:"absolute",left:"-9999px"});this.$input_source.appendTo(u);this._InitPrompt();this._SetupEvents();this.Write(this.header,"jqconsole-header");d(u).data("jqconsole",this)}t.prototype.Reset=function(){if(this.state!==i){this.ClearPromptText(true)}this.state=i;this.input_queue=[];this.input_callback=null;this.multiline_callback=null;this.history=[];this.history_index=0;this.history_current="";this.shortcuts={};this.$prompt.detach();this.$console.html("");this.$prompt.appendTo(this.$console);this.Write(this.header,"jqconsole-header")};t.prototype.RegisterShortcut=function(w,v){var u;if(isNaN(w)){w=w.charCodeAt(0)}else{w=parseInt(w,10)}if(!((0<w&&w<256))||isNaN(w)){throw new Error("Key code must be a number between 0 and 256 exclusive.")}if(!v instanceof Function){throw new Error("Callback must be a function, not "+v+".")}u=b(function(x){if(!(x in this.shortcuts)){this.shortcuts[x]=[]}return this.shortcuts[x].push(v)},this);u(w);if((65<=w&&w<=90)){u(w+32)}if((97<=w&&w<=122)){u(w-32)}};t.prototype.GetColumn=function(){var u;this.$prompt_cursor.text("");u=this.$console.text().split("\n");this.$prompt_cursor.text(" ");return u[u.length-1].length};t.prototype.GetLine=function(){return this.$console.text().split("\n").length-1};t.prototype.ClearPromptText=function(u){if(this.state===i){throw new Error("ClearPromptText() is not allowed in output state.")}this.$prompt_before.html("");this.$prompt_after.html("");this.$prompt_label.text(u?"":this._SelectPromptLabel(false));this.$prompt_left.text("");this.$prompt_right.text("")};t.prototype.GetPromptText=function(u){var y,v,w,z,x;if(this.state===i){throw new Error("GetPromptText() is not allowed in output state.")}if(u){this.$prompt_cursor.text("");x=this.$prompt.text();this.$prompt_cursor.text(" ");return x}else{z=function(B){var A;A=[];B.children().each(function(){return A.push(d(":last-child",this).text())});return A.join("\n")};v=z(this.$prompt_before);if(v){v+="\n"}w=this.$prompt_left.text()+this.$prompt_right.text();y=z(this.$prompt_after);if(y){y="\n"+y}return v+w+y}};t.prototype.SetPromptText=function(u){if(this.state===i){throw new Error("SetPromptText() is not allowed in output state.")}this.ClearPromptText(false);this._AppendPromptText(u);this._ScrollToEnd()};t.prototype.Write=function(w,u){var v;v=d("<span>").text(w);if(u!=null){v.addClass(u)}v.insertBefore(this.$prompt);this._ScrollToEnd();this.$prompt_cursor.detach().insertAfter(this.$prompt_left)};t.prototype.Input=function(u){if(this.state!==i){this.input_queue.push(b(function(){return this.Input(u)},this));return}this.history_active=false;this.input_callback=u;this.multiline_callback=null;this.state=h;this.$prompt.attr("class","jqconsole-input");this.$prompt_label.text(this._SelectPromptLabel(false));this.Focus();this._ScrollToEnd()};t.prototype.Prompt=function(v,w,u){if(this.state!==i){this.input_queue.push(b(function(){return this.Prompt(v,w,u)},this));return}this.history_active=v;this.input_callback=w;this.multiline_callback=u;this.state=k;this.$prompt.attr("class","jqconsole-prompt");this.$prompt_label.text(this._SelectPromptLabel(false));this.Focus();this._ScrollToEnd()};t.prototype.AbortPrompt=function(){if(this.state!==k){throw new Error("Cannot abort prompt when not in prompt state.")}this.Write(this.GetPromptText(true)+"\n","jqconsole-old-prompt");this.ClearPromptText(true);this.state=i;this.input_callback=this.multiline_callback=null;this._CheckInputQueue()};t.prototype.Focus=function(){this.$input_source.focus()};t.prototype.SetIndentWidth=function(u){return this.indent_width=u};t.prototype.GetIndentWidth=function(){return this.indent_width};t.prototype._CheckInputQueue=function(){if(this.input_queue.length){return this.input_queue.shift()()}};t.prototype._InitPrompt=function(){this.$prompt=d('<span class="jqconsole-input"/>').appendTo(this.$console);this.$prompt_before=d("<span/>").appendTo(this.$prompt);this.$prompt_current=d("<span/>").appendTo(this.$prompt);this.$prompt_after=d("<span/>").appendTo(this.$prompt);this.$prompt_label=d("<span/>").appendTo(this.$prompt_current);this.$prompt_left=d("<span/>").appendTo(this.$prompt_current);this.$prompt_right=d("<span/>").appendTo(this.$prompt_current);this.$prompt_right.css({position:"relative"});this.$prompt_cursor=d('<span class="jqconsole-cursor"> </span>');this.$prompt_cursor.insertBefore(this.$prompt_right);return this.$prompt_cursor.css({color:"transparent",display:"inline",position:"absolute",zIndex:0})};t.prototype._SetupEvents=function(){var u,v;this.$console.click(b(function(){var w;w=b(function(){var x;x=function(){var y;if(window.getSelection){return window.getSelection().toString()}else{if(((y=document.selection)!=null?y.type:void 0)==="Text"){return document.selection.createRange().text}}};if(x()===""){return this.Focus()}},this);return setTimeout(w,0)},this));this.$input_source.focus(b(function(){return this.$console.removeClass("jqconsole-blurred")},this));this.$input_source.blur(b(function(){return this.$console.addClass("jqconsole-blurred")},this));v=d.browser.opera?"input":"paste";this.$input_source.bind(v,b(function(){var w;w=b(function(){this._AppendPromptText(this.$input_source.val());this.$input_source.val("");return this.Focus()},this);return setTimeout(w,0)},this));this.$input_source.keypress(b(function(w){return this._HandleChar(w)},this));u=d.browser.mozilla?"keypress":"keydown";return this.$input_source[u](b(function(w){return this._HandleKey(w)},this))};t.prototype._HandleChar=function(v){var u;if(this.state===i){return true}u=v.which;if(u===13||u===9){return false}if(d.browser.mozilla){if(v.keyCode||v.metaKey||v.ctrlKey||v.altKey){return true}}if(d.browser.opera){if(v.keyCode||v.which||v.metaKey||v.ctrlKey||v.altKey){return true}}if(v.metaKey||v.ctrlKey||v.altKey){return false}this.$prompt_left.text(this.$prompt_left.text()+String.fromCharCode(u));this._ScrollToEnd();return false};t.prototype._HandleKey=function(v){var u;if(this.state===i){return true}u=v.keyCode||v.which;if(v.altKey||v.metaKey&&!v.ctrlKey){return true}else{if(v.ctrlKey){return this._HandleCtrlShortcut(u)}else{if(v.shiftKey){switch(u){case e:this._HandleEnter(true);break;case o:this._Unindent();break;case m:this._MoveUp();break;case c:this._MoveDown();break;default:return true}return false}else{switch(u){case e:this._HandleEnter(false);break;case o:this._Indent();break;case j:this._Delete(false);break;case r:this._Backspace(false);break;case s:this._MoveLeft(false);break;case f:this._MoveRight(false);break;case m:this._HistoryPrevious();break;case c:this._HistoryNext();break;case l:this._MoveToStart(false);break;case q:this._MoveToEnd(false);break;default:return true}return false}}}};t.prototype._HandleCtrlShortcut=function(v){var w,y,u,x;switch(v){case j:this._Delete(true);break;case r:this._Backspace(true);break;case s:this._MoveLeft(true);break;case f:this._MoveRight(true);break;case m:this._MoveUp();break;case c:this._MoveDown();break;case q:this._MoveToEnd(true);break;case l:this._MoveToStart(true);break;default:if(v in this.shortcuts){x=this.shortcuts[v];for(y=0,u=x.length;y<u;y++){w=x[y];w.call(this)}return false}else{return true}}return false};t.prototype._HandleEnter=function(w){var B,A,u,z,x,y,v;if(w){return this._InsertNewLine(true)}else{z=this.GetPromptText();u=this.multiline_callback?this.multiline_callback(z):false;if(u!==false){this._MoveToEnd(true);this._InsertNewLine(true);v=[];for(x=0,y=Math.abs(u);0<=y?x<y:x>y;0<=y?x++:x--){v.push(u>0?this._Indent():this._Unindent())}return v}else{A=this.state===h?"input":"prompt";this.Write(this.GetPromptText(true)+"\n","jqconsole-old-"+A);this.ClearPromptText(true);if(this.history_active){if(!this.history.length||this.history[this.history.length-1]!==z){this.history.push(z);this.history_index=this.history.length}}this.state=i;B=this.input_callback;this.input_callback=null;if(B){B(z)}return this._CheckInputQueue()}}};t.prototype._MoveUp=function(){var u;if(this.$prompt_before.is(":empty")){return}u=this.$prompt_left.text().length;this._MoveToStart();this._MoveLeft();this.$prompt_right.text(this.$prompt_left.text().slice(u));return this.$prompt_left.text(this.$prompt_left.text().slice(0,u))};t.prototype._MoveDown=function(){var u;if(this.$prompt_after.is(":empty")){return}u=this.$prompt_left.text().length;this._MoveToEnd();this._MoveRight();this.$prompt_left.text(this.$prompt_right.text().slice(0,u));return this.$prompt_right.text(this.$prompt_right.text().slice(u))};t.prototype._MoveLeft=function(y){var v,u,x,w;x=this.$prompt_left.text();if(x){if(y){w=x.match(/\w*\W*$/);if(!w){return}w=w[0];this.$prompt_right.text(w+this.$prompt_right.text());return this.$prompt_left.text(x.slice(0,-w.length))}else{this.$prompt_right.text(x.slice(-1)+this.$prompt_right.text());return this.$prompt_left.text(x.slice(0,-1))}}else{if(!this.$prompt_before.is(":empty")){v=d("<span/>").prependTo(this.$prompt_after);v.append(d("<span/>").text(this.$prompt_label.text()));v.append(d("<span/>").text(this.$prompt_right.text()));u=this.$prompt_before.children().last().detach();this.$prompt_label.text(u.children().first().text());this.$prompt_left.text(u.children().last().text());return this.$prompt_right.text("")}}};t.prototype._MoveRight=function(y){var v,u,x,w;x=this.$prompt_right.text();if(x){if(y){w=x.match(/^\w*\W*/);if(!w){return}w=w[0];this.$prompt_left.text(this.$prompt_left.text()+w);return this.$prompt_right.text(x.slice(w.length))}else{this.$prompt_left.text(this.$prompt_left.text()+x[0]);return this.$prompt_right.text(x.slice(1))}}else{if(!this.$prompt_after.is(":empty")){u=d("<span/>").appendTo(this.$prompt_before);u.append(d("<span/>").text(this.$prompt_label.text()));u.append(d("<span/>").text(this.$prompt_left.text()));v=this.$prompt_after.children().first().detach();this.$prompt_label.text(v.children().first().text());this.$prompt_left.text("");return this.$prompt_right.text(v.children().last().text())}}};t.prototype._MoveToStart=function(v){var u;if(v){u=[];while(!(this.$prompt_before.is(":empty")&&this.$prompt_left.text()==="")){this._MoveToStart(false);u.push(this._MoveLeft(false))}return u}else{this.$prompt_right.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_left.text("")}};t.prototype._MoveToEnd=function(v){var u;if(v){u=[];while(!(this.$prompt_after.is(":empty")&&this.$prompt_right.text()==="")){this._MoveToEnd(false);u.push(this._MoveRight(false))}return u}else{this.$prompt_left.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_right.text("")}};t.prototype._Delete=function(x){var u,w,v;w=this.$prompt_right.text();if(w){if(x){v=w.match(/^\w*\W*/);if(!v){return}v=v[0];return this.$prompt_right.text(w.slice(v.length))}else{return this.$prompt_right.text(w.slice(1))}}else{if(!this.$prompt_after.is(":empty")){u=this.$prompt_after.children().first().detach();return this.$prompt_right.text(u.children().last().text())}}};t.prototype._Backspace=function(x){var u,w,v;w=this.$prompt_left.text();if(w){if(x){v=w.match(/\w*\W*$/);if(!v){return}v=v[0];return this.$prompt_left.text(w.slice(0,-v.length))}else{return this.$prompt_left.text(w.slice(0,-1))}}else{if(!this.$prompt_before.is(":empty")){u=this.$prompt_before.children().last().detach();this.$prompt_label.text(u.children().first().text());return this.$prompt_left.text(u.children().last().text())}}};t.prototype._Indent=function(){var u;return this.$prompt_left.prepend(((function(){var w,v;v=[];for(u=1,w=this.indent_width;1<=w?u<=w:u>=w;1<=w?u++:u--){v.push(" ")}return v}).call(this)).join(""))};t.prototype._Unindent=function(){var x,v,w,u;x=this.$prompt_left.text()+this.$prompt_right.text();u=[];for(v=1,w=this.indent_width;1<=w?v<=w:v>=w;1<=w?v++:v--){if(!/^ /.test(x)){break}if(this.$prompt_left.text()){this.$prompt_left.text(this.$prompt_left.text().slice(1))}else{this.$prompt_right.text(this.$prompt_right.text().slice(1))}u.push(x=x.slice(1))}return u};t.prototype._InsertNewLine=function(u){var x,v,w;if(u==null){u=false}w=this._SelectPromptLabel(!this.$prompt_before.is(":empty"));x=d("<span/>").appendTo(this.$prompt_before);x.append(d("<span/>").text(w));x.append(d("<span/>").text(this.$prompt_left.text()));this.$prompt_label.text(this._SelectPromptLabel(true));if(u&&(v=this.$prompt_left.text().match(/^\s+/))){this.$prompt_left.text(v[0])}else{this.$prompt_left.text("")}return this._ScrollToEnd()};t.prototype._AppendPromptText=function(A){var x,w,z,v,y,u;w=A.split("\n");this.$prompt_left.text(this.$prompt_left.text()+w[0]);y=w.slice(1);u=[];for(z=0,v=y.length;z<v;z++){x=y[z];this._InsertNewLine();u.push(this.$prompt_left.text(x))}return u};t.prototype._ScrollToEnd=function(){return this.$console.scrollTop(this.$console[0].scrollHeight)};t.prototype._SelectPromptLabel=function(u){if(this.state===k){if(u){return this.prompt_label_continue}else{return this.prompt_label_main}}else{if(u){return"\n "}else{return" "}}};t.prototype._HistoryPrevious=function(){if(!this.history_active){return}if(this.history_index<=0){return}if(this.history_index===this.history.length){this.history_new=this.GetPromptText()}return this.SetPromptText(this.history[--this.history_index])};t.prototype._HistoryNext=function(){if(!this.history_active){return}if(this.history_index>=this.history.length){return}if(this.history_index===this.history.length-1){this.history_index++;return this.SetPromptText(this.history_new)}else{return this.SetPromptText(this.history[++this.history_index])}};return t})();d.fn.jqconsole=function(v,u,t){return new g(this,v,u,t)}}).call(this);