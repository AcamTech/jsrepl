(function(){var c,d,l,o,i,a,h,g,b,k,n,e,m,j;var f=function(p,q){return function(){return p.apply(q,arguments)}};c=jQuery;m=0;j=1;h=13;n=9;o=46;l=8;b=37;k=39;e=38;i=40;g=36;a=35;d=(function(){function p(q,r){this.header=r!=null?r:"";this.state=j;this.saved_lines=[];this.enter_callback=null;this.multiline_callback=null;this.history=[];this.history_index=0;this.history_new="";this.history_active=false;this.shortcuts={};this.$console=c('<pre class="jqconsole"/>').appendTo(q);this.$prompt=c('<span class="jqconsole-input"/>');this.$prompt_left=c("<span/>").appendTo(this.$prompt);this.$prompt_left.css({position:"relative"});this.$prompt_right=c("<span/>").appendTo(this.$prompt);this.$prompt_right.css({position:"relative"});this.$prompt_cursor=c('<span class="jqconsole-cursor"> </span>');this.$prompt_cursor.insertBefore(this.$prompt_right);this.$prompt_cursor.css({color:"transparent",display:"inline",position:"absolute",zIndex:0});this.$input_source=c("<textarea/>");this.$input_source.css({position:"absolute",left:"-9999px"});this.$input_source.appendTo(q);this.SetupEvents();this.Write(this.header,"jqconsole-header");c(q).data("jqconsole",this)}p.prototype.Reset=function(){this.history=[];this.history_index=0;this.history_current="";this.state=j;this.shortcuts={};this.$prompt_left.text("");this.$prompt_right.text("");if(this.$prompt.parent()){this.$prompt.detach()}this.$console.html("");return this.Write(this.header,"jqconsole-header")};p.prototype.RegisterShortcut=function(r,q){r=parseInt(r,10);if(isNaN(r)||(!0<r&&r<256)){throw new Error("Key code must be a number between 0 and 256 exclusive.")}if(!q instanceof Function){throw new Error("Callback must be a function, not "+q+".")}if(!(this.shortcuts[r]!=null)){this.shortcuts[r]=[]}return this.shortcuts[r].push(q)};p.prototype.Write=function(s,q){var r;if(this.state!==j){throw new Error("Write() is only allowed in output state.")}r=c("<span>");r.text(s);if(q!=null){r.addClass(q)}r.appendTo(this.$console);return this.ScrollToEnd()};p.prototype.GetPromptText=function(){if(this.state!==m){throw new Error("GetPromptText() is only allowed in input state.")}return this.$prompt_left.text()+this.$prompt_right.text()};p.prototype.SetPromptText=function(q){if(this.state!==m){throw new Error("SetPromptText() is only allowed in input state.")}this.$prompt_left.text(q);this.$prompt_right.text("");return this.ScrollToEnd()};p.prototype.Input=function(r,s,q){if(this.state!==j){throw new Error("Input() is only allowed in output state.")}this.history_active=r;this.enter_callback=s;this.multiline_callback=q;this.$prompt.appendTo(this.$console);this.Focus();this.ScrollToEnd();return this.state=m};p.prototype.Focus=function(){return this.$input_source.focus()};p.prototype.SetupEvents=function(){var q;this.$console.mouseup(f(function(){return this.Focus()},this));this.$input_source.bind("paste",f(function(){var r;r=f(function(){this.$prompt_left.text(this.$prompt_left.text()+this.$input_source.val());this.$input_source.val("");return this.$input_source.focus()},this);return setTimeout(r,0)},this));this.$input_source.keypress(f(function(r){return this.HandleChar(r)},this));q=c.browser.mozilla?"keypress":"keydown";return this.$input_source[q](f(function(r){return this.HandleKey(r)},this))};p.prototype.ScrollToEnd=function(){return this.$console.scrollTop(this.$console[0].scrollHeight)};p.prototype.HandleChar=function(r){var q;if(this.state===j){return true}if(c.browser.mozilla&&!r.charCode){return true}if(c.browser.opera&&!r.which){return true}q=r.which;if(q===13||q===9){return false}if(r.metaKey||r.ctrlKey||r.altKey){return false}this.$prompt_left.text(this.$prompt_left.text()+String.fromCharCode(q));this.ScrollToEnd();return false};p.prototype.HandleKey=function(r){var q;if(this.state===j){return true}if(r.altKey||r.shiftKey||(r.metaKey&&!r.ctrlKey)){return true}else{if(r.ctrlKey){return this.HandleCtrlShortcut(r.keyCode)}else{q=r.keyCode;switch(q){case h:this.HandleEnter(r.shiftKey);break;case n:this.InsertTab();break;case o:this.Delete(false);break;case l:this.Backspace(false);break;case b:this.MoveLeft(false);break;case k:this.MoveRight(false);break;case e:this.HistoryPrevious();break;case i:this.HistoryNext();break;case g:this.MoveToStart();break;case a:this.MoveToEnd();break;default:return true}return false}}};p.prototype.HandleCtrlShortcut=function(r){var s,u,q,t;switch(r){case o:this.Delete(true);break;case l:this.Backspace(true);break;case b:this.MoveLeft(true);break;case k:this.MoveRight(true);break;default:if(this.shortcuts[r]!=null){t=this.shortcuts[r];for(u=0,q=t.length;u<q;u++){s=t[u];s.call(this)}return false}else{return true}}return false};p.prototype.MoveLeft=function(s){var r,q;r=this.$prompt_left.text();if(!r){return}if(s){q=r.match(/\w*\W*$/);if(!q){return}q=q[0];this.$prompt_right.text(q+this.$prompt_right.text());return this.$prompt_left.text(r.slice(0,-q.length))}else{this.$prompt_right.text(r.slice(-1)+this.$prompt_right.text());return this.$prompt_left.text(r.slice(0,-1))}};p.prototype.MoveRight=function(s){var r,q;r=this.$prompt_right.text();if(!r){return}if(s){q=r.match(/^\w*\W*/);if(!q){return}q=q[0];this.$prompt_left.text(this.$prompt_left.text()+q);return this.$prompt_right.text(r.slice(q.length))}else{this.$prompt_left.text(this.$prompt_left.text()+r[0]);return this.$prompt_right.text(r.slice(1))}};p.prototype.Delete=function(s){var r,q;r=this.$prompt_right.text();if(!r){return}if(s){q=r.match(/^\w*\W*/);if(!q){return}q=q[0];return this.$prompt_right.text(r.slice(q.length))}else{return this.$prompt_right.text(r.slice(1))}};p.prototype.Backspace=function(s){var r,q;r=this.$prompt_left.text();if(!r){return}if(s){q=r.match(/\w*\W*$/);if(!q){return}q=q[0];return this.$prompt_left.text(r.slice(0,-q.length))}else{return this.$prompt_left.text(r.slice(0,-1))}};p.prototype.InsertTab=function(){return this.$prompt_left.append("  ")};p.prototype.MoveToStart=function(){this.$prompt_right.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_left.text("")};p.prototype.MoveToEnd=function(){this.$prompt_left.text(this.$prompt_left.text()+this.$prompt_right.text());return this.$prompt_right.text("")};p.prototype.HistoryPrevious=function(){if(!this.history_active){return}if(this.history_index<=0){return}if(this.history_index===this.history.length){this.history_new=this.GetPromptText()}return this.SetPromptText(this.history[--this.history_index])};p.prototype.HistoryNext=function(){if(!this.history_active){return}if(this.history_index>=this.history.length){return}if(this.history_index===this.history.length-1){this.history_index++;return this.SetPromptText(this.history_new)}else{return this.SetPromptText(this.history[++this.history_index])}};p.prototype.HandleEnter=function(q){var s,r;if(q){}else{this.saved_lines.push(this.GetPromptText());this.SetPromptText("");r=this.saved_lines.join("\n");if(this.multiline_callback&&this.multiline_callback(r)){}else{if(this.history_active){if(!this.history.length||this.history[this.history.length-1]!==r){this.history.push(r);this.history_index=this.history.length}}this.saved_lines=[];this.$prompt.detach();this.state=j;this.Write(r+"\n");s=this.enter_callback;this.enter_callback=null;return s(r)}}};return p})();c.fn.jqconsole=function(p){return new d(this,p)}}).call(this);