var BiwaScheme=BiwaScheme||{};BiwaScheme.Version="0.5.4.2";BiwaScheme.GitCommit="495e231425d4bbe001e4b2dc34ab91279ff6e1c7";BiwaScheme.TopEnv={};BiwaScheme.CoreEnv={};BiwaScheme.Error=Class.create({initialize:function(a){this.message="Error: "+a},toString:function(){return this.message}});BiwaScheme.Bug=Class.create(Object.extend(new BiwaScheme.Error(),{initialize:function(a){this.message="[BUG] "+a}}));BiwaScheme.UserError=Class.create(Object.extend(new BiwaScheme.Error(),{initialize:function(a){this.message=a}}));BiwaScheme.Set=Class.create({initialize:function(){this.arr=[];var a;for(a=0;a<arguments.length;a++){this.arr[a]=arguments[a]}},equals:function(c){if(this.arr.length!=c.arr.length){return false}var d=this.arr.clone();var a=c.arr.clone();d.sort();a.sort();for(var e=0;e<this.arr.length;e++){if(d[e]!=a[e]){return false}}return true},set_cons:function(a){var c=new BiwaScheme.Set(a);c.arr=this.arr.clone();c.arr.push(a);return c},set_union:function(){var e=new BiwaScheme.Set();e.arr=this.arr.clone();for(var a=0;a<arguments.length;a++){var c=arguments[a];if(!c instanceof BiwaScheme.Set){throw new BiwaScheme.Error("set_union: arguments must be a set")}for(var d=0;d<c.arr.length;d++){e.add(c.arr[d])}}return e},set_intersect:function(a){if(!a instanceof BiwaScheme.Set){throw new BiwaScheme.Error("set_intersect: arguments must be a set")}var d=new BiwaScheme.Set();for(var c=0;c<this.arr.length;c++){if(a.member(this.arr[c])){d.add(this.arr[c])}}return d},set_minus:function(a){if(!a instanceof BiwaScheme.Set){throw new BiwaScheme.Error("set_minus: arguments must be a set")}var d=new BiwaScheme.Set();for(var c=0;c<this.arr.length;c++){if(!a.member(this.arr[c])){d.add(this.arr[c])}}return d},add:function(a){if(!this.member(a)){this.arr.push(a)}},member:function(c){for(var a=0;a<this.arr.length;a++){if(this.arr[a]==c){return true}}return false},rindex:function(c){for(var a=this.arr.length-1;a>=0;a--){if(this.arr[a]==c){return(this.arr.length-1-a)}}return null},index:function(c){for(var a=0;a<this.arr.length;a++){if(this.arr[a]==c){return a}}return null},inspect:function(){return"Set("+this.arr.join(", ")+")"},toString:function(){return this.inspect()},size:function(){return this.arr.length}});Function.prototype.to_write=function(){return"#<Function "+(this.fname?this.fname:this.toSource?this.toSource().truncate(40):"")+">"};String.prototype.to_write=function(){return'"'+this.replace(/\\|\"/g,function(a){return"\\"+a}).replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r")+'"'};Array.prototype.to_write=function(){if(this.closure_p){return"#<Closure>"}var c=[];for(var d=0;d<this.length;d++){c.push(BiwaScheme.to_write(this[d]))}return"#("+c.join(" ")+")"};BiwaScheme.to_write=function(a){if(a===undefined){return"undefined"}else{if(a===null){return"null"}else{if(typeof(a.to_write)=="function"){return a.to_write()}else{if(isNaN(a)&&typeof(a)=="number"){return"+nan.0"}else{switch(a){case true:return"#t";case false:return"#f";case Infinity:return"+inf.0";case -Infinity:return"-inf.0"}}}}}return Object.inspect(a)};BiwaScheme.to_display=function(a){if(typeof(a.valueOf())=="string"){return a}else{if(a instanceof BiwaScheme.Symbol){return a.name}else{if(a instanceof Array){return"#("+a.map(BiwaScheme.to_display).join(" ")+")"}else{if(a instanceof BiwaScheme.Pair){return a.inspect(BiwaScheme.to_display)}else{if(a instanceof BiwaScheme.Char){return a.value}else{return BiwaScheme.to_write(a)}}}}}};BiwaScheme.write_ss=function(f,a){var e=[f],d=[false];BiwaScheme.find_cyclic(f,e,d);var h=BiwaScheme.reduce_cyclic_info(e,d);var g=new Array(h.length);for(var c=h.length-1;c>=0;c--){g[c]=false}return BiwaScheme.to_write_ss(f,h,g,a)};BiwaScheme.to_write_ss=function(g,k,j,c){var e="";var f=k.indexOf(g);if(f>=0){if(j[f]){return"#"+f+"#"}else{j[f]=true;e="#"+f+"="}}if(g instanceof BiwaScheme.Pair){var d=[];d.push(BiwaScheme.to_write_ss(g.car,k,j,c));for(var h=g.cdr;h!=BiwaScheme.nil;h=h.cdr){if(!(h instanceof BiwaScheme.Pair)||k.indexOf(h)>=0){d.push(".");d.push(BiwaScheme.to_write_ss(h,k,j,c));break}d.push(BiwaScheme.to_write_ss(h.car,k,j,c))}e+="("+d.join(" ")+")"}else{if(g instanceof Array){var d=g.map(function(a){return BiwaScheme.to_write_ss(a,k,j,c)});if(c){e+="["+d.join(", ")+"]"}else{e+="#("+d.join(" ")+")"}}else{e+=BiwaScheme.to_write(g)}}return e};BiwaScheme.reduce_cyclic_info=function(e,d){var c=0;for(var a=0;a<d.length;a++){if(d[a]){e[c]=e[a];c++}}return e.slice(0,c)};BiwaScheme.find_cyclic=function(e,d,c){var a=(e instanceof BiwaScheme.Pair)?[e.car,e.cdr]:(e instanceof Array)?e:null;if(!a){return}a.each(function(g){if(typeof(g)=="number"||typeof(g)=="string"||g===BiwaScheme.undef||g===true||g===false||g===BiwaScheme.nil||g instanceof BiwaScheme.Symbol){return}var f=d.indexOf(g);if(f>=0){c[f]=true}else{d.push(g);c.push(false);BiwaScheme.find_cyclic(g,d,c)}})};BiwaScheme.Pair=Class.create({initialize:function(a,c){this.car=a;this.cdr=c},caar:function(){return this.car.car},cadr:function(){return this.cdr.car},cdar:function(){return this.cdr.car},cddr:function(){return this.cdr.cdr},first:function(){return this.car},second:function(){return this.cdr.car},third:function(){return this.cdr.cdr.car},fourth:function(){return this.cdr.cdr.cdr.car},fifth:function(){return this.cdr.cdr.cdr.cdr.car},to_array:function(){var a=[];for(var c=this;c instanceof BiwaScheme.Pair;c=c.cdr){a.push(c.car)}return a},to_set:function(){var c=new BiwaScheme.Set();for(var a=this;a instanceof BiwaScheme.Pair;a=a.cdr){c.add(a.car)}return c},length:function(){var c=0;for(var a=this;a instanceof BiwaScheme.Pair;a=a.cdr){c++}return c},foreach:function(a){for(var c=this;c instanceof BiwaScheme.Pair;c=c.cdr){a(c.car)}return c},map:function(c){var a=[];for(var d=this;BiwaScheme.isPair(d);d=d.cdr){a.push(c(d.car))}return a},concat:function(a){var c=this;while(c instanceof BiwaScheme.Pair&&c.cdr!=BiwaScheme.nil){c=c.cdr}c.cdr=a;return this},inspect:function(e){e||(e=Object.inspect);var c=[];var d=this.foreach(function(a){c.push(e(a))});if(d!=BiwaScheme.nil){c.push(".");c.push(e(d))}return"("+c.join(" ")+")"},toString:function(){return this.inspect()},to_write:function(){return this.inspect(BiwaScheme.to_write)}});BiwaScheme.List=function(){return $A(arguments).to_list()};BiwaScheme.build_list=function(c){var d=BiwaScheme.nil;for(var a=c.length-1;a>=0;a--){var e=c[a];if(Object.isArray(e)&&!e.is_vector){e=BiwaScheme.build_list(e)}d=new BiwaScheme.Pair(e,d)}return d};Array.prototype.to_list=function(){var c=BiwaScheme.nil;for(var a=this.length-1;a>=0;a--){c=new BiwaScheme.Pair(this[a],c)}return c};BiwaScheme.Values=Class.create({initialize:function(a){this.content=a},to_write:function(){return"#<Values "+this.content.map(BiwaScheme.to_write).join(" ")+">"}});BiwaScheme.nil={toString:function(){return"nil"},to_write:function(){return"()"},to_array:function(){return[]},length:function(){return 0}};BiwaScheme.undef=new Object();BiwaScheme.undef.toString=function(){return"#<undef>"};BiwaScheme.eof=new Object;BiwaScheme.Symbol=Class.create({initialize:function(a){this.name=a;BiwaScheme.Symbols[a]=this},inspect:function(){return"'"+this.name},toString:function(){return"'"+this.name},to_write:function(){return this.name}});BiwaScheme.Symbols={};BiwaScheme.Sym=function(a,c){if(BiwaScheme.Symbols[a]===undefined){return new BiwaScheme.Symbol(a)}else{if(!(BiwaScheme.Symbols[a] instanceof BiwaScheme.Symbol)){return new BiwaScheme.Symbol(a)}else{return BiwaScheme.Symbols[a]}}};BiwaScheme.gensyms=0;BiwaScheme.gensym=function(){BiwaScheme.gensyms++;return BiwaScheme.Sym("__gensym_"+BiwaScheme.gensyms)};BiwaScheme.Char=Class.create({initialize:function(a){BiwaScheme.Chars[this.value=a]=this},to_write:function(){switch(this.value){case"\n":return"#\\newline";case" ":return"#\\space";case"\t":return"#\\tab";default:return"#\\"+this.value}},inspect:function(){return this.to_write()}});BiwaScheme.Chars={};BiwaScheme.Char.get=function(a){if(typeof(a)!="string"){throw new BiwaScheme.Bug("Char.get: "+Object.inspect(a)+" is not a string")}if(BiwaScheme.Chars[a]===undefined){return new BiwaScheme.Char(a)}else{return BiwaScheme.Chars[a]}};BiwaScheme.Complex=Class.create({initialize:function(c,a){this.real=c;this.imag=a},magnitude:function(){return Math.sqrt(this.real*this.real+this.imag*this.imag)},angle:function(){return Math.acos(this.real/this.magnitude())}});BiwaScheme.Complex.from_polar=function(c,a){var e=c*Math.cos(a);var d=c*Math.sin(a);return new BiwaScheme.Complex(e,d)};BiwaScheme.Complex.assure=function(a){if(a instanceof BiwaScheme.Complex){return a}else{return new BiwaScheme.Complex(a,0)}};BiwaScheme.Rational=Class.create({initialize:function(a,c){this.numerator=a;this.denominator=c}});BiwaScheme.Port=Class.create({initialize:function(a,c){this.is_open=true;this.is_binary=false;this.is_input=a;this.is_output=c},close:function(){this.is_open=false},inspect:function(){return"#<Port>"},to_write:function(){return"#<Port>"}});BiwaScheme.Port.BrowserInput=Class.create(BiwaScheme.Port,{initialize:function($super){$super(true,false)},get_string:function(c){var a=document.createElement("div");a.innerHTML="<input id='webscheme-read-line' type='text'><input id='webscheme-read-line-submit' type='button' value='ok'>";$("bs-console").appendChild(a);return new BiwaScheme.Pause(function(d){Event.observe($("webscheme-read-line-submit"),"click",function(){var e=$("webscheme-read-line").value;a.parentNode.removeChild(a);BiwaScheme.Port.current_output.put_string(e);d.resume(c(e))})})}});BiwaScheme.Port.DefaultOutput=Class.create(BiwaScheme.Port,{initialize:function($super){$super(false,true)},put_string:function(a){}});BiwaScheme.Port.StringOutput=Class.create(BiwaScheme.Port,{initialize:function($super){this.buffer=[];$super(false,true)},put_string:function(a){this.buffer.push(a)},output_string:function(a){return this.buffer.join("")}});BiwaScheme.Port.StringInput=Class.create(BiwaScheme.Port,{initialize:function($super,a){this.str=a;$super(true,false)},get_string:function(a){return a(this.str)}});BiwaScheme.Port.current_input=new BiwaScheme.Port.BrowserInput();BiwaScheme.Port.current_output=new BiwaScheme.Port.DefaultOutput();BiwaScheme.Port.current_error=new BiwaScheme.Port.DefaultOutput();BiwaScheme.Record=Class.create({initialize:function(c,a){assert_record_td(c,"new Record");this.rtd=c;this.fields=a},get:function(a){return this.fields[a]},set:function(c,a){this.fields[c]=a},toString:function(){var a=BiwaScheme.to_write(this.fields);return"#<Record "+this.rtd.name+" "+a+">"}});BiwaScheme.isRecord=function(a){return(a instanceof BiwaScheme.Record)};BiwaScheme.Record._DefinedTypes=new Hash();BiwaScheme.Record.define_type=function(a,c,d){return BiwaScheme.Record._DefinedTypes.set(a,{rtd:c,cd:d})};BiwaScheme.Record.get_type=function(a){return BiwaScheme.Record._DefinedTypes.get(a)};BiwaScheme.Record.RTD=Class.create({initialize:function(e,d,f,c,g,a){this.name=e;this.parent_rtd=d;this.is_base_type=!d;if(f){this.uid=f;this.generative=false}else{this.uid=this._generate_new_uid();this.generative=true}this.sealed=!!c;this.opaque=d.opaque||(!!g);this.fields=a.map(function(h){return{name:h[0],mutable:!!h[1]}})},_generate_new_uid:function(){var a=(BiwaScheme.Record.RTD.last_uid++);return BiwaScheme.Sym("__record_td_uid_"+a)},toString:function(){return"#<RecordTD "+name+">"}});BiwaScheme.Record.RTD.last_uid=0;BiwaScheme.Record.RTD.NongenerativeRecords=new Hash();BiwaScheme.isRecordTD=function(a){return(a instanceof BiwaScheme.Record.RTD)};BiwaScheme.Record.CD=Class.create({initialize:function(a,c,d){this._check(a,c,d);this.rtd=a;this.parent_cd=c;if(d){this.has_custom_protocol=true;this.protocol=d}else{this.has_custom_protocol=false;if(a.parent_rtd){this.protocol=this._default_protocol_for_derived_types()}else{this.protocol=this._default_protocol_for_base_types()}}},_check:function(a,c,d){if(a.is_base_type&&c){throw new Error("Record.CD.new: cannot specify parent cd of a base type")}if(c&&a.parent_rtd&&(c.rtd!=a.parent_rtd)){throw new Error("Record.CD.new: mismatched parents between rtd and parent_cd")}if(a.parent_rtd&&!c&&d){throw new Error("Record.CD.new: protocol must be #f when parent_cd is not given")}if(c&&c.has_custom_protocol&&!d){throw new Error("Record.CD.new: protocol must be specified when parent_cd has a custom protocol")}},_default_protocol_for_base_types:function(){return function(a){var c=a[0];assert_procedure(c,"_default_protocol/base");return c}},_default_protocol_for_derived_types:function(){var a=this.rtd;return function(c){var e=c[0];assert_procedure(e,"_default_protocol/n");var d=function(g){var j=a.fields.length;var k=g.length-j;var f=g.slice(0,k);var h=g.slice(k);return new BiwaScheme.Call(e,f,function(l){var m=l[0];assert_procedure(m,"_default_protocol/p");return new BiwaScheme.Call(m,h,function(p){var o=p[0];assert_record(o,"_default_protocol/result");return o})})};return d}},toString:function(){return"#<RecordCD "+this.rtd.name+">"},record_constructor:function(){var a=(this.parent_cd?this._make_n([],this.rtd):this._make_p()).bind(this);return new BiwaScheme.Call(this.protocol,[a],function(c){var d=c[0];assert_procedure(d,"record_constructor");return d})},_make_p:function(){return function(a){return new BiwaScheme.Record(this.rtd,a)}},_make_n:function(a,c){var d=this.parent_cd;if(d){var e=function(g){var f=function(k){var j=[].concat(k[0]).concat(a);var h=d._make_n(j,c);return new BiwaScheme.Call(d.protocol,[h],function(l){var m=l[0];assert_procedure(m,"_make_n");return new BiwaScheme.Call(m,g,function(p){var o=p[0];assert_record(o);return o})})};return f};return e}else{var e=function(g){var f=g.concat(a);return new BiwaScheme.Record(c,f)};return e}}});BiwaScheme.isRecordCD=function(a){return(a instanceof BiwaScheme.Record.CD)};BiwaScheme.Hashtable=Class.create({initialize:function(c,d,a){this.mutable=(a===undefined)?true:a?true:false;this.hash_proc=c;this.equiv_proc=d;this.pairs_of=new Hash()},clear:function(){this.pairs_of=new Hash()},candidate_pairs:function(a){return this.pairs_of.get(a)},add_pair:function(e,a,d){var c=this.pairs_of.get(e);if(c){c.push([a,d])}else{this.pairs_of.set(e,[[a,d]])}},remove_pair:function(d,e){var c=this.pairs_of.get(d);var a=c.indexOf(e);if(a==-1){throw new BiwaScheme.Bug("Hashtable#remove_pair: pair not found!")}else{c.splice(a,1)}},create_copy:function(a){var c=new BiwaScheme.Hashtable(this.hash_proc,this.equiv_proc,a);this.pairs_of.each(function(e){var d=e[1].map(function(f){return f.clone()});c.pairs_of.set(e[0],d)});return c},size:function(){var a=0;this._apply_pair(function(c){a++});return a},keys:function(){return this._apply_pair(function(a){return a[0]})},values:function(){return this._apply_pair(function(a){return a[1]})},_apply_pair:function(d){var c=[];this.pairs_of.values().each(function(a){a.each(function(e){c.push(d(e))})});return c},to_write:function(){return"#<Hashtable size="+this.size()+">"}});BiwaScheme.Hashtable.equal_hash=function(a){return BiwaScheme.to_write(a[0])};BiwaScheme.Hashtable.eq_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.eqv_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.string_hash=function(a){return a[0]};BiwaScheme.Hashtable.string_ci_hash=function(a){return Object.isString(a[0])?a[0].toLowerCase():a[0]};BiwaScheme.Hashtable.symbol_hash=function(a){return(a[0] instanceof BiwaScheme.Symbol)?a[0].name:a[0]};BiwaScheme.Hashtable.eq_equiv=function(a){return BiwaScheme.eq(a[0],a[1])};BiwaScheme.Hashtable.eqv_equiv=function(a){return BiwaScheme.eqv(a[0],a[1])};BiwaScheme.Syntax=Class.create({initialize:function(a,c){this.sname=a;this.func=c},transform:function(a){if(!this.func){throw new BiwaScheme.Bug("sorry, syntax "+this.sname+" is a pseudo syntax now")}return this.func(a)},inspect:function(){return"#<Syntax "+this.sname+">"}});BiwaScheme.TopEnv.define=new BiwaScheme.Syntax("define");BiwaScheme.TopEnv.begin=new BiwaScheme.Syntax("begin");BiwaScheme.TopEnv.quote=new BiwaScheme.Syntax("quote");BiwaScheme.TopEnv.lambda=new BiwaScheme.Syntax("lambda");BiwaScheme.TopEnv["if"]=new BiwaScheme.Syntax("if");BiwaScheme.TopEnv["set!"]=new BiwaScheme.Syntax("set!");BiwaScheme.isNil=function(a){return(a===BiwaScheme.nil)};BiwaScheme.isUndef=function(a){return(a===BiwaScheme.undef)};BiwaScheme.isChar=function(a){return(a instanceof BiwaScheme.Char)};BiwaScheme.isSymbol=function(a){return(a instanceof BiwaScheme.Symbol)};BiwaScheme.isPort=function(a){return(a instanceof BiwaScheme.Port)};BiwaScheme.isPair=function(a){return(a instanceof BiwaScheme.Pair)};BiwaScheme.isList=function(a){if(a===BiwaScheme.nil){return true}if(!(a instanceof BiwaScheme.Pair)){return false}return BiwaScheme.isList(a.cdr)};BiwaScheme.isVector=function(a){return(a instanceof Array)&&(a.closure_p!==true)};BiwaScheme.isHashtable=function(a){return(a instanceof BiwaScheme.Hashtable)};BiwaScheme.isMutableHashtable=function(a){return(a instanceof BiwaScheme.Hashtable)&&a.mutable};BiwaScheme.isClosure=function(a){return(a instanceof Array)&&(a.closure_p===true)};BiwaScheme.isProcedure=function(a){return BiwaScheme.isClosure(a)||Object.isFunction(a)};BiwaScheme.Parser=Class.create({initialize:function(a){this.tokens=this.tokenize(a);this.i=0},inspect:function(){return["#<Parser:",this.i,"/",this.tokens.length," ",Object.inspect(this.tokens),">"].join("")},tokenize:function(a){var e=new Array(),c=null;var d=0;while(a!=""&&c!=a){c=a;a=a.replace(/^\s*(;[^\r\n]*(\r|\n|$)|#;|#\||#\\[^\w]|#?(\(|\[|{)|\)|\]|}|\'|`|,@|,|\+inf\.0|-inf\.0|\+nan\.0|\"(\\(.|$)|[^\"\\])*(\"|$)|[^\s()\[\]{}]+)/,function(g,f){var h=f;if(h=="#|"){d++;return""}else{if(d>0){if(/(.*\|#)/.test(h)){d--;if(d<0){throw new BiwaScheme.Error("Found an extra comment terminator: `|#'")}return h.substring(RegExp.$1.length,h.length)}else{return""}}else{if(h.charAt(0)!=";"){e[e.length]=h}return""}}})}return e},sexpCommentMarker:new Object,getObject:function(){var a=this.getObject0();if(a!=this.sexpCommentMarker){return a}a=this.getObject();if(a==BiwaScheme.Parser.EOS){throw new BiwaScheme.Error("Readable object not found after S exression comment")}a=this.getObject();return a},getList:function(f){var c=BiwaScheme.nil,a=c;while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in list)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}if(this.tokens[this.i]=="."){this.i++;var e=this.getObject();if(e!=BiwaScheme.Parser.EOS&&c!=BiwaScheme.nil){a.cdr=e}}else{var d=new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil);if(c==BiwaScheme.nil){c=d}else{a.cdr=d}a=d}}return c},getVector:function(c){var a=new Array();while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in vector)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}a[a.length]=this.getObject()}return a},eatObjectsInSexpComment:function(a){while(this.tokens[this.i]=="#;"){this.i++;if((this.getObject()==BiwaScheme.Parser.EOS)||(this.i>=this.tokens.length)){throw new BiwaScheme.Error(a)}}},getObject0:function(){if(this.i>=this.tokens.length){return BiwaScheme.Parser.EOS}var a=this.tokens[this.i++];if(a=="#;"){return this.sexpCommentMarker}var c=a=="'"?"quote":a=="`"?"quasiquote":a==","?"unquote":a==",@"?"unquote-splicing":false;if(c||a=="("||a=="#("||a=="["||a=="#["||a=="{"||a=="#{"){return c?new BiwaScheme.Pair(BiwaScheme.Sym(c),new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil)):(a=="("||a=="["||a=="{")?this.getList(a):this.getVector(a)}else{switch(a){case"+inf.0":return Infinity;case"-inf.0":return -Infinity;case"+nan.0":return NaN}var d;if(/^#x[0-9a-z]+$/i.test(a)){d=new Number("0x"+a.substring(2,a.length))}else{if(/^#d[0-9\.]+$/i.test(a)){d=new Number(a.substring(2,a.length))}else{d=new Number(a)}}if(!isNaN(d)){return d.valueOf()}else{if(a=="#f"||a=="#F"){return false}else{if(a=="#t"||a=="#T"){return true}else{if(a.toLowerCase()=="#\\newline"){return BiwaScheme.Char.get("\n")}else{if(a.toLowerCase()=="#\\space"){return BiwaScheme.Char.get(" ")}else{if(a.toLowerCase()=="#\\tab"){return BiwaScheme.Char.get("\t")}else{if(/^#\\.$/.test(a)){return BiwaScheme.Char.get(a.charAt(2))}else{if(/^\"(\\(.|$)|[^\"\\])*\"?$/.test(a)){return a.replace(/(\r?\n|\\n)/g,"\n").replace(/^\"|\\(.|$)|\"$/g,function(f,e){return e?e:""})}else{return BiwaScheme.Sym(a)}}}}}}}}}}});BiwaScheme.Parser.EOS=new Object();BiwaScheme.Compiler=Class.create({initialize:function(){},is_tail:function(a){return(a[0]=="return")},collect_free:function(h,g,d){var f=h;var j=d;var a=f.arr;for(var c=0;c<a.length;c++){j=this.compile_refer(a[c],g,["argument",j])}return j},compile_refer:function(a,d,c){return this.compile_lookup(a,d,function(e){return["refer-local",e,c]},function(e){return["refer-free",e,c]},function(e){return["refer-global",e,c]})},compile_lookup:function(a,g,j,k,d){var f=g[0],h=g[1];if((n=f.index(a))!=null){return j(n)}else{if((n=h.index(a))!=null){return k(n)}else{var c=a.name;return d(c)}}},make_boxes:function(f,g,e){var g=g;var j=0;var c=[];while(g instanceof BiwaScheme.Pair){if(f.member(g.car)){c.push(j)}j++;g=g.cdr}var h=e;for(var d=c.length-1;d>=0;d--){h=["box",c[d],h]}return h},find_sets:function(l,o){var j=null;if(l instanceof BiwaScheme.Symbol){j=new BiwaScheme.Set()}else{if(l instanceof BiwaScheme.Pair){switch(l.first()){case BiwaScheme.Sym("define"):var f=l.third();j=this.find_sets(f,o);case BiwaScheme.Sym("begin"):j=this.find_sets(l.cdr,o);break;case BiwaScheme.Sym("quote"):j=new BiwaScheme.Set();break;case BiwaScheme.Sym("lambda"):var k=l.second(),g=l.cdr.cdr;if(k instanceof BiwaScheme.Pair){j=this.find_sets(g,o.set_minus(k.to_set()))}else{j=this.find_sets(g,o.set_minus(new BiwaScheme.Set(k)))}break;case BiwaScheme.Sym("if"):var q=l.second(),e=l.third(),h=l.fourth();j=this.find_sets(q,o).set_union(this.find_sets(e,o),this.find_sets(h,o));break;case BiwaScheme.Sym("set!"):var c=l.second(),a=l.third();if(o.member(c)){j=this.find_sets(a,o).set_cons(c)}else{j=this.find_sets(a,o)}break;case BiwaScheme.Sym("call/cc"):var f=l.second();j=this.find_sets(f,o);break;default:var m=new BiwaScheme.Set();for(var d=l;d instanceof BiwaScheme.Pair;d=d.cdr){m=m.set_union(this.find_sets(d.car,o))}j=m;break}}else{j=new BiwaScheme.Set()}}if(j==null){throw new BiwaScheme.Bug("find_sets() exited in unusual way")}else{return j}},find_free:function(o,m,h){var k=null;if(o instanceof BiwaScheme.Symbol){if(h.member(o)){k=new BiwaScheme.Set(o)}else{k=new BiwaScheme.Set()}}else{if(o instanceof BiwaScheme.Pair){switch(o.first()){case BiwaScheme.Sym("define"):var e=o.third();k=this.find_free(e,m,h);break;case BiwaScheme.Sym("begin"):k=this.find_free(o.cdr,m,h);break;case BiwaScheme.Sym("quote"):k=new BiwaScheme.Set();break;case BiwaScheme.Sym("lambda"):var l=o.second(),g=o.cdr.cdr;if(l instanceof BiwaScheme.Pair){k=this.find_free(g,m.set_union(l.to_set()),h)}else{k=this.find_free(g,m.set_cons(l),h)}break;case BiwaScheme.Sym("if"):var r=o.second(),d=o.third(),j=o.fourth();k=this.find_free(r,m,h).set_union(this.find_free(d,m,h),this.find_free(j,m,h));break;case BiwaScheme.Sym("set!"):var a=o.second(),e=o.third();if(h.member(a)){k=this.find_free(e,m,h).set_cons(a)}else{k=this.find_free(e,m,h)}break;case BiwaScheme.Sym("call/cc"):var e=o.second();k=this.find_free(e,m,h);break;default:var q=new BiwaScheme.Set();for(var c=o;c instanceof BiwaScheme.Pair;c=c.cdr){q=q.set_union(this.find_free(c.car,m,h))}k=q;break}}else{k=new BiwaScheme.Set()}}if(k==null){throw new BiwaScheme.Bug("find_free() exited in unusual way")}else{return k}},find_dot_pos:function(c){var a=0;for(;c instanceof BiwaScheme.Pair;c=c.cdr,++a){}if(c!=BiwaScheme.nil){return a}else{return -1}},last_pair:function(a){if(a instanceof BiwaScheme.Pair){for(;a.cdr instanceof BiwaScheme.Pair;a=a.cdr){}}return a},dotted2proper:function(a){var e=function(g){var h=BiwaScheme.nil;for(;g instanceof BiwaScheme.Pair;){var j=g.cdr;g.cdr=h;h=g;g=j}return h};var d=function(g){var h=BiwaScheme.nil;for(;g instanceof BiwaScheme.Pair;g=g.cdr){h=new BiwaScheme.Pair(g.car,h)}return e(h)};if(a instanceof BiwaScheme.Pair){var f=this.last_pair(a);if(f instanceof BiwaScheme.Pair&&f.cdr===BiwaScheme.nil){return a}else{var c=d(a);this.last_pair(c).cdr=new BiwaScheme.Pair(f.cdr,BiwaScheme.nil);return c}}else{return new BiwaScheme.Pair(a,BiwaScheme.nil)}},compile:function(t,K,C,J,G){var O=null;while(1){if(t instanceof BiwaScheme.Symbol){return this.compile_refer(t,K,(C.member(t)?["indirect",G]:G))}else{if(t instanceof BiwaScheme.Pair){switch(t.first()){case BiwaScheme.Sym("define"):if(t.length()!=3){throw new BiwaScheme.Error("Invalid define: "+t.to_write())}var j=t.cdr.car;var q=t.cdr.cdr;if(j instanceof BiwaScheme.Symbol){t=q.car;BiwaScheme.TopEnv[j.name]=BiwaScheme.undef;G=["assign-global",j.name,G]}else{if(j instanceof BiwaScheme.Pair){var N=j.car,h=j.cdr;var z=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(h,q));t=z;BiwaScheme.TopEnv[N.name]=BiwaScheme.undef;G=["assign-global",N.name,G]}else{throw new BiwaScheme.Error("compile: define needs a leftbol or pair: got "+j)}}break;case BiwaScheme.Sym("begin"):var M=[];for(var F=t.cdr;F instanceof BiwaScheme.Pair;F=F.cdr){M.push(F.car)}var L=G;for(var I=M.length-1;I>=0;I--){L=this.compile(M[I],K,C,J,L)}return L;case BiwaScheme.Sym("quote"):if(t.length()<2){throw new BiwaScheme.Error("Invalid quote: "+t.to_write())}var A=t.second();return["constant",A,G];case BiwaScheme.Sym("lambda"):if(t.length()<3){throw new BiwaScheme.Error("Invalid lambda: "+t.to_write())}var D=t.cdr.car;var u=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),t.cdr.cdr);var m=this.find_dot_pos(D);var B=this.dotted2proper(D);var y=this.find_free(u,B.to_set(),J);var d=this.find_sets(u,B.to_set());var H=this.compile(u,[B.to_set(),y],d.set_union(C.set_intersect(y)),J.set_union(B.to_set()),["return"]);var r=["close",y.size(),this.make_boxes(d,B,H),G,m];return this.collect_free(y,K,r);case BiwaScheme.Sym("if"):if(t.length()<3||t.length()>4){throw new BiwaScheme.Error("Invalid if: "+t.to_write())}var E=t.second(),l=t.third(),o=t.fourth();var l=this.compile(l,K,C,J,G);var o=this.compile(o,K,C,J,G);t=E;G=["test",l,o];break;case BiwaScheme.Sym("set!"):if(t.length()!=3){throw new BiwaScheme.Error("Invalid set!: "+t.to_write())}var w=t.second(),t=t.third();var g=this.compile_lookup(w,K,function(a){return["assign-local",a,G]},function(a){return["assign-free",a,G]},function(a){return["assign-global",a,G]});G=g;break;case BiwaScheme.Sym("call/cc"):var t=t.second();var L=["conti",(this.is_tail(G)?(K[0].size()+1):0),["argument",["constant",1,["argument",this.compile(t,K,C,J,(this.is_tail(G)?["shift",1,["apply"]]:["apply"]))]]]];return this.is_tail(G)?L:["frame",L,G];default:var k=t.car;var h=t.cdr;var L=this.compile(k,K,C,J,this.is_tail(G)?["shift",h.length(),["apply"]]:["apply"]);L=this.compile(h.length(),K,C,J,["argument",L]);for(var F=h;F instanceof BiwaScheme.Pair;F=F.cdr){L=this.compile(F.car,K,C,J,["argument",L])}return this.is_tail(G)?L:["frame",L,G]}}else{return["constant",t,G]}}}},run:function(a){return this.compile(a,[new BiwaScheme.Set(),new BiwaScheme.Set()],new BiwaScheme.Set(),new BiwaScheme.Set(),["halt"])}});BiwaScheme.Compiler.compile=function(c,a){c=(new BiwaScheme.Interpreter).expand(c);return(new BiwaScheme.Compiler).run(c,a)};BiwaScheme.Pause=Class.create({initialize:function(a){this.on_pause=a},set_state:function(d,a,g,h,e){this.interpreter=d;this.x=a;this.f=g;this.c=h;this.s=e},ready:function(){this.on_pause(this)},resume:function(a){return this.interpreter.resume(true,a,this.x,this.f,this.c,this.s)}});BiwaScheme.Call=Class.create({initialize:function(a,c,d){this.proc=a;this.args=c;this.after=d||function(e){return e[0]}},inspect:function(){return"#<Call args="+this.args.inspect()+">"},toString:function(){return"#<Call>"},to_write:function(){return"#<Call>"}});BiwaScheme.Iterator={ForArray:Class.create({initialize:function(a){this.arr=a;this.i=0},has_next:function(){return this.i<this.arr.length},next:function(){return this.arr[this.i++]}}),ForString:Class.create({initialize:function(a){this.str=a;this.i=0},has_next:function(){return this.i<this.str.length},next:function(){return BiwaScheme.Char.get(this.str.charAt(this.i++))}}),ForList:Class.create({initialize:function(a){this.ls=a},has_next:function(){return(this.ls instanceof BiwaScheme.Pair)&&this.ls!=BiwaScheme.nil},next:function(){var a=this.ls;this.ls=this.ls.cdr;return a}}),ForMulti:Class.create({initialize:function(a){this.objs=a;this.size=a.length;this.iterators=a.map(function(c){return BiwaScheme.Iterator.of(c)})},has_next:function(){for(var a=0;a<this.size;a++){if(!this.iterators[a].has_next()){return false}}return true},next:function(){return this.iterators.map(function(a){return a.next()})}}),of:function(a){switch(true){case (a instanceof Array):return new this.ForArray(a);case (typeof(a)=="string"):return new this.ForString(a);case (a instanceof BiwaScheme.Pair):case (a===BiwaScheme.nil):return new this.ForList(a);default:throw new BiwaScheme.Bug("Iterator.of: unknown class: "+Object.inspect(a))}}};BiwaScheme.Call.default_callbacks={call:function(a){return new BiwaScheme.Call(this.proc,[a])},result:Prototype.emptyFunction,finish:Prototype.emptyFunction};BiwaScheme.Call.foreach=function(g,f,d){d||(d=false);["call","result","finish"].each(function(h){if(!f[h]){f[h]=BiwaScheme.Call.default_callbacks[h]}});var e=null;var a=null;var c=function(j){if(e){var k=f.result(j[0],a);if(k!==undefined){return k}}else{if(d){e=new BiwaScheme.Iterator.ForMulti(g)}else{e=BiwaScheme.Iterator.of(g)}}if(!e.has_next()){return f.finish()}else{a=e.next();var h=f.call(a);h.after=c;return h}};return c(null)};BiwaScheme.Call.multi_foreach=function(c,a){return BiwaScheme.Call.foreach(c,a,true)};BiwaScheme.Interpreter=Class.create({initialize:function(a){this.stack=[];this.on_error=a||function(c){};this.after_evaluate=Prototype.emptyFunction},inspect:function(){return["#<Interpreter: stack size=>",this.stack.length," ","after_evaluate=",Object.inspect(this.after_evaluate),">"].join("")},push:function(a,c){this.stack[c]=a;return c+1},save_stack:function(d){var a=[];for(var c=0;c<d;c++){a[c]=this.stack[c]}return a},restore_stack:function(a){var d=a.length;for(var c=0;c<d;c++){this.stack[c]=a[c]}return d},continuation:function(c,d){var a=this.push(d,c);return this.closure(["refer-local",0,["nuate",this.save_stack(a),["return"]]],0,null,-1)},shift_args:function(e,a,d){for(var c=e-1;c>=-1;c--){this.index_set(d,c+a+1,this.index(d,c))}return d-a-1},index:function(c,a){return this.stack[c-a-2]},index_set:function(d,c,a){this.stack[d-c-2]=a},closure:function(a,g,e,f){var c=[];c[0]=a;for(var d=0;d<g;d++){c[d+1]=this.index(e,d-1)}c[g+1]=f;c.closure_p=true;return c},execute:function(g,d,l,o,j){var h=null;try{h=this._execute(g,d,l,o,j)}catch(m){var k={a:g,x:d,f:l,c:o,s:j,stack:this.stack};return this.on_error(m,k)}return h},run_dump_hook:function(e,d,k,l,h){var g;var j;if(this.dumper){g=this.dumper}else{if(BiwaScheme.Interpreter.dumper){g=BiwaScheme.Interpreter.dumper}else{return}}if(g){var j=new Hash({a:e,f:k,c:l,s:h,x:d,stack:this.stack});g.dump(j)}},_execute:function(H,r,D,G,z){var I=null;while(true){this.run_dump_hook(H,r,D,G,z);switch(r[0]){case"halt":return H;case"refer-local":var A=r[1],r=r[2];H=this.index(D,A);break;case"refer-free":var A=r[1],r=r[2];H=G[A+1];break;case"refer-global":var w=r[1],r=r[2];if(BiwaScheme.TopEnv.hasOwnProperty(w)){var J=BiwaScheme.TopEnv[w]}else{if(BiwaScheme.CoreEnv.hasOwnProperty(w)){var J=BiwaScheme.CoreEnv[w]}else{throw new BiwaScheme.Error("execute: unbound symbol: "+Object.inspect(w))}}H=J;break;case"indirect":var r=r[1];H=H[0];break;case"constant":var y=r[1],r=r[2];H=y;break;case"close":var g=r;var A=g[1],v=g[2],r=g[3],k=g[4];H=this.closure(v,A,z,k);z-=A;break;case"box":var A=r[1],r=r[2];this.index_set(z,A,[this.index(z,A)]);break;case"test":var l=r[1],m=r[2];r=((H!==false)?l:m);break;case"assign-global":var K=r[1],r=r[2];if(!BiwaScheme.TopEnv.hasOwnProperty(K)&&!BiwaScheme.CoreEnv.hasOwnProperty(K)){throw new BiwaScheme.Error("global variable '"+K+"' is not defined")}BiwaScheme.TopEnv[K]=H;H=BiwaScheme.undef;break;case"assign-local":var A=r[1],r=r[2];var t=this.index(D,A);t[0]=H;H=BiwaScheme.undef;break;case"assign-free":var A=r[1],r=r[2];var t=G[A+1];t[0]=H;H=BiwaScheme.undef;break;case"conti":var A=r[1],r=r[2];H=this.continuation(z,A);break;case"nuate":var p=r[1],r=r[2];z=this.restore_stack(p);break;case"frame":var I=r[2];r=r[1];z=this.push(I,this.push(D,this.push(G,z)));break;case"argument":var r=r[1];z=this.push(H,z);break;case"shift":var A=r[1],r=r[2];var e=this.index(z,A);z=this.shift_args(A,e,z);break;case"apply":var h=H;var e=this.index(z,-1);if(h instanceof Array){H=h;r=h[0];var k=h[h.length-1];if(k>=0){var o=BiwaScheme.nil;for(var C=e;--C>=k;){o=new BiwaScheme.Pair(this.index(z,C),o)}if(k>=e){for(var C=-1;C<e;C++){this.index_set(z,C-1,this.index(z,C))}z++;this.index_set(z,-1,this.index(z,-1)+1)}this.index_set(z,k,o)}D=z;G=H}else{if(h instanceof Function){var d=[];for(var C=0;C<e;C++){d.push(this.index(z,C))}var u=h(d,this);if(u instanceof BiwaScheme.Pause){var j=u;j.set_state(this,["return"],D,G,z);j.ready();return j}else{if(u instanceof BiwaScheme.Call){var F=["frame",["argument",["constant",1,["argument",["constant",u.after,["apply"]]]]],["return"]];var q=["constant",u.args.length,["argument",["constant",u.proc,["apply",u.args.length]]]];var E=u.args.inject(q,function(c,a){return["constant",a,["argument",c]]});r=["frame",E,F]}else{H=u;r=["return"]}}}else{throw new BiwaScheme.Error(Object.inspect(h)+" is not a function")}}break;case"return":var A=this.index(z,-1);var B=z-A;r=this.index(B,0),D=this.index(B,1),G=this.index(B,2),z=B-3-1;break;default:throw new BiwaScheme.Bug("unknown opecode type: "+r[0])}}return H},expand:function(o,k){k||(k={});var h=null;if(o instanceof BiwaScheme.Symbol){h=o}else{if(o instanceof BiwaScheme.Pair){switch(o.car){case BiwaScheme.Sym("define"):var d=o.cdr.car,e=o.cdr.cdr;h=new BiwaScheme.Pair(BiwaScheme.Sym("define"),new BiwaScheme.Pair(d,this.expand(e,k)));break;case BiwaScheme.Sym("begin"):h=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),this.expand(o.cdr,k));break;case BiwaScheme.Sym("quote"):h=o;break;case BiwaScheme.Sym("lambda"):var j=o.cdr.car,f=o.cdr.cdr;h=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(j,this.expand(f,k)));break;case BiwaScheme.Sym("if"):var r=o.second(),c=o.third(),g=o.fourth();if(g==BiwaScheme.inner_of_nil){g=BiwaScheme.undef}h=[BiwaScheme.Sym("if"),this.expand(r,k),this.expand(c,k),this.expand(g,k)].to_list();break;case BiwaScheme.Sym("set!"):var q=o.second(),o=o.third();h=[BiwaScheme.Sym("set!"),q,this.expand(o,k)].to_list();break;case BiwaScheme.Sym("call-with-current-continuation"):case BiwaScheme.Sym("call/cc"):var o=o.second();h=[BiwaScheme.Sym("call/cc"),this.expand(o,k)].to_list();break;default:if(o.car instanceof BiwaScheme.Symbol&&BiwaScheme.TopEnv[o.car.name] instanceof BiwaScheme.Syntax){var l=BiwaScheme.TopEnv[o.car.name];k.modified=true;h=l.transform(o);if(BiwaScheme.Debug){var m=BiwaScheme.to_write(o);var a=BiwaScheme.to_write(h);if(m!=a){BiwaScheme.Port.current_output.put_string("expand: "+m+" => "+a)}}var p;for(;;){h=this.expand(h,p={});if(!p.modified){break}}}else{if(o==BiwaScheme.nil){h=BiwaScheme.nil}else{h=new BiwaScheme.Pair(this.expand(o.car,k),o.cdr.to_array().map(function(s){return this.expand(s,k)}.bind(this)).to_list())}}}}else{h=o}}return h},evaluate:function(c,a){this.parser=new BiwaScheme.Parser(c);this.compiler=new BiwaScheme.Compiler();if(a){this.after_evaluate=a}if(BiwaScheme.Debug){BiwaScheme.Port.current_output.put_string("executing: "+c)}this.is_top=true;this.file_stack=[];return this.resume(false)},resume:function(e,j,k,d,h,o){var g=BiwaScheme.undef;for(;;){if(e){g=this.execute(j,k,d,h,o);e=false}else{if(!this.parser){break}var l=this.parser.getObject();if(l===BiwaScheme.Parser.EOS){break}l=this.expand(l);var m=this.compiler.run(l);g=this.execute(l,m,0,[],0)}if(g instanceof BiwaScheme.Pause){return g}}this.after_evaluate(g);return g},invoke_closure:function(f,d){d||(d=[]);var c=d.length;var a=["constant",c,["argument",["constant",f,["apply"]]]];for(var e=0;e<c;e++){a=["constant",d[e],["argument",a]]}return this.execute(f,["frame",a,["halt"]],0,f,0)},compile:function(c){var a=BiwaScheme.Interpreter.read(c);var d=BiwaScheme.Compiler.compile(a);return d}});BiwaScheme.Interpreter.read=function(c){var d=new BiwaScheme.Parser(c);var a=d.getObject();return(a==BiwaScheme.Parser.EOS)?BiwaScheme.eof:a};BiwaScheme.check_arity=function(c,d,a){var e=arguments.callee.caller?arguments.callee.caller.fname:"(?)";if(c<d){if(a&&a==d){throw new BiwaScheme.Error(e+": wrong number of arguments (expected: "+d+" got: "+c+")")}else{throw new BiwaScheme.Error(e+": too few arguments (at least: "+d+" got: "+c+")")}}else{if(a&&a<c){throw new BiwaScheme.Error(e+": too many arguments (at most: "+a+" got: "+c+")")}}};BiwaScheme.define_libfunc=function(h,c,a,d,g){var e=function(k,j){BiwaScheme.check_arity(k.length,c,a);var f=d(k,j);if(g){return f}else{if(f===undefined){throw new BiwaScheme.Bug("library function `"+h+"' returned JavaScript's undefined")}else{if(f===null){throw new BiwaScheme.Bug("library function `"+h+"' returned JavaScript's null")}else{return f}}}};d.fname=h;e.fname=h;e.inspect=function(){return this.fname};BiwaScheme.CoreEnv[h]=e};BiwaScheme.define_libfunc_raw=function(e,c,a,d){BiwaScheme.define_libfunc(e,c,a,d,true)};BiwaScheme.define_syntax=function(a,d){var c=new BiwaScheme.Syntax(a,d);BiwaScheme.TopEnv[a]=c};BiwaScheme.define_scmfunc=function(e,c,a,d){(new Interpreter).evaluate("(define "+e+" "+d+"\n)")};var make_assert=function(a){return function(){var c=arguments.callee.caller?arguments.callee.caller.fname:"";a.apply(this,[c].concat($A(arguments)))}};var make_simple_assert=function(a,c){return make_assert(function(f,e,d){option=d?("("+d+")"):"";if(!c(e)){throw new BiwaScheme.Error(f+option+": "+a+" required, but got "+BiwaScheme.to_write(e))}})};var assert_number=make_simple_assert("number",function(a){return typeof(a)=="number"||(a instanceof BiwaScheme.Complex)});var assert_integer=make_simple_assert("integer",function(a){return typeof(a)=="number"&&(a%1==0)});var assert_real=make_simple_assert("real number",function(a){return typeof(a)=="number"});var assert_between=make_assert(function(e,a,d,c){if(typeof(a)!="number"||a!=Math.round(a)){throw new BiwaScheme.Error(e+": number required, but got "+BiwaScheme.to_write(a))}if(a<d||c<a){throw new BiwaScheme.Error(e+": number must be between "+d+" and "+c+", but got "+BiwaScheme.to_write(a))}});var assert_string=make_simple_assert("string",Object.isString);var assert_char=make_simple_assert("character",BiwaScheme.isChar);var assert_symbol=make_simple_assert("symbol",BiwaScheme.isSymbol);var assert_port=make_simple_assert("port",BiwaScheme.isPort);var assert_pair=make_simple_assert("pair",BiwaScheme.isPair);var assert_list=make_simple_assert("list",BiwaScheme.isList);var assert_vector=make_simple_assert("vector",BiwaScheme.isVector);var assert_hashtable=make_simple_assert("hashtable",BiwaScheme.isHashtable);var assert_mutable_hashtable=make_simple_assert("mutable hashtable",BiwaScheme.isMutableHashtable);var assert_record=make_simple_assert("record",BiwaScheme.isRecord);var assert_record_td=make_simple_assert("record type descriptor",BiwaScheme.isRecordTD);var assert_record_cd=make_simple_assert("record constructor descriptor",BiwaScheme.isRecordCD);var assert_function=make_simple_assert("JavaScript function",Object.isFunction);var assert_closure=make_simple_assert("scheme function",BiwaScheme.isClosure);var assert_procedure=make_simple_assert("scheme/js function",function(a){return BiwaScheme.isClosure(a)||Object.isFunction(a)});var assert_date=make_simple_assert("date",function(a){return a instanceof Date});var assert=make_assert(function(d,c,a){if(!c){throw new BiwaScheme.Error(d+": "+a)}});if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_syntax("cond",function(a){var d=a.cdr;if(!(d instanceof Pair)||d===nil){throw new Error("malformed cond: cond needs list but got "+to_write_ss(d))}var c=null;d.to_array().reverse().each(function(g){if(!(g instanceof Pair)){throw new Error("bad clause in cond: "+to_write_ss(g))}if(g.car===Sym("else")){if(c!==null){throw new Error("'else' clause of cond followed by more clauses: "+to_write_ss(d))}else{if(g.cdr===nil){c=false}else{if(g.cdr.cdr===nil){c=g.cdr.car}else{c=new Pair(Sym("begin"),g.cdr)}}}}else{if(c===null){c=BiwaScheme.undef}else{var h=g.car;if(g.cdr===nil){c=[Sym("or"),h,c].to_list()}else{if(g.cdr.cdr===nil){c=[Sym("if"),h,g.cdr.car,c].to_list()}else{if(g.cdr.car===Sym("=>")){var h=g.car,f=g.cdr.cdr.car;var e=BiwaScheme.gensym();c=List(Sym("let"),List(List(e,h)),List(Sym("if"),h,List(f,e),c))}else{c=[Sym("if"),h,new Pair(Sym("begin"),g.cdr),c].to_list()}}}}}});return c});define_syntax("case",function(a){var e=BiwaScheme.gensym();if(a.cdr===nil){throw new Error("case: at least one clause is required")}else{if(!(a.cdr instanceof Pair)){throw new Error("case: proper list is required")}else{var d=a.cdr.car;var f=a.cdr.cdr;var c=undefined;f.to_array().reverse().each(function(g){if(g.car===Sym("else")){if(c===undefined){c=new Pair(Sym("begin"),g.cdr)}else{throw new Error("case: 'else' clause followed by more clauses: "+to_write_ss(f))}}else{c=[Sym("if"),new Pair(Sym("or"),g.car.to_array().map(function(h){return[Sym("eqv?"),e,[Sym("quote"),h].to_list()].to_list()}).to_list()),new Pair(Sym("begin"),g.cdr),c].to_list()}});return new Pair(Sym("let1"),new Pair(e,new Pair(d,new Pair(c,nil))))}}});define_syntax("and",function(a){if(a.cdr==nil){return true}var e=a.cdr.to_array();var d=e.length-1;var c=e[d];for(d=d-1;d>=0;d--){c=[Sym("if"),e[d],c,false].to_list()}return c});define_syntax("or",function(a){var e=a.cdr.to_array();var d=false;for(var c=e.length-1;c>=0;c--){d=[Sym("if"),e[c],e[c],d].to_list()}return d});define_syntax("let",function(k){var a=null;if(k.cdr.car instanceof Symbol){a=k.cdr.car;k=k.cdr}var d=k.cdr.car,e=k.cdr.cdr;if(!(d instanceof Pair)){throw new Error("let: need a pair for bindings: got "+to_write(d))}var h=nil,j=nil;for(var c=d;c instanceof Pair;c=c.cdr){h=new Pair(c.car.car,h);j=new Pair(c.car.cdr.car,j)}var g=null;if(a){h=h.to_array().reverse().to_list();j=j.to_array().reverse().to_list();var f=new Pair(Sym("lambda"),new Pair(h,e));var l=new Pair(a,j);g=[Sym("letrec"),new Pair([a,f].to_list(),nil),l].to_list()}else{g=new Pair(new Pair(Sym("lambda"),new Pair(h,e)),j)}return g});define_syntax("let*",function(c){var e=c.cdr.car,a=c.cdr.cdr;if(!(e instanceof Pair)){throw new Error("let*: need a pair for bindings: got "+to_write(e))}var d=null;e.to_array().reverse().each(function(f){d=new Pair(Sym("let"),new Pair(new Pair(f,nil),d==null?a:new Pair(d,nil)))});return d});var expand_letrec_star=function(c){var f=c.cdr.car,a=c.cdr.cdr;if(!(f instanceof Pair)){throw new Error("letrec*: need a pair for bindings: got "+to_write(f))}var e=a;f.to_array().reverse().each(function(g){e=new Pair(new Pair(Sym("set!"),g),e)});var d=nil;f.to_array().reverse().each(function(g){d=new Pair(new Pair(g.car,new Pair(BiwaScheme.undef,nil)),d)});return new Pair(Sym("let"),new Pair(d,e))};define_syntax("letrec",expand_letrec_star);define_syntax("letrec*",expand_letrec_star);define_syntax("let-values",function(c){var g=c.cdr.car;var a=c.cdr.cdr;var d=null;var f=nil;var e=nil;g.to_array().reverse().each(function(k){var o=k.cdr.car;var l=BiwaScheme.gensym();var m=new Pair(l,new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(o,nil))),nil));f=new Pair(m,f);var j=k.car;e=new Pair(new Pair(j,new Pair(new Pair(l,nil),nil)),e)});var h=new Pair(Sym("let*-values"),new Pair(e,a));d=new Pair(Sym("let"),new Pair(f,new Pair(h,nil)));return d});define_syntax("let*-values",function(c){var e=c.cdr.car;var a=c.cdr.cdr;var d=null;e.to_array().reverse().each(function(g){var f=g.car,h=g.cdr.car;d=new Pair(Sym("call-with-values"),new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(h,nil))),new Pair(new Pair(Sym("lambda"),new Pair(f,(d==null?a:new Pair(d,nil)))),nil)))});return d});BiwaScheme.eq=function(d,c){return d===c};BiwaScheme.eqv=function(d,c){return d==c&&(typeof(d)==typeof(c))};define_libfunc("eqv?",2,2,function(a){return BiwaScheme.eqv(a[0],a[1])});define_libfunc("eq?",2,2,function(a){return BiwaScheme.eq(a[0],a[1])});define_libfunc("equal?",2,2,function(a){return to_write(a[0])==to_write(a[1])});define_libfunc("procedure?",1,1,function(a){return((a[0] instanceof Array)&&(a[0].closure_p===true)||(typeof a[0]=="function"))});define_libfunc("number?",1,1,function(a){return(typeof(a[0])=="number")||(a[0] instanceof Complex)||(a[0] instanceof Rational)});define_libfunc("complex?",1,1,function(a){return(a[0] instanceof Complex)});define_libfunc("real?",1,1,function(a){return(typeof(a[0])=="number")});define_libfunc("rational?",1,1,function(a){return(a[0] instanceof Rational)});define_libfunc("integer?",1,1,function(a){return typeof(a[0])=="number"&&a[0]==Math.round(a[0])&&a[0]!=Infinity&&a[0]!=-Infinity});define_libfunc("=",2,null,function(c){var a=c[0];assert_number(c[0]);for(var d=1;d<c.length;d++){assert_number(c[d]);if(c[d]!=a){return false}}return true});define_libfunc("<",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]<a[c])){return false}}return true});define_libfunc(">",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]>a[c])){return false}}return true});define_libfunc("<=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]<=a[c])){return false}}return true});define_libfunc(">=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]>=a[c])){return false}}return true});define_libfunc("zero?",1,1,function(a){assert_number(a[0]);return a[0]===0});define_libfunc("positive?",1,1,function(a){assert_number(a[0]);return(a[0]>0)});define_libfunc("negative?",1,1,function(a){assert_number(a[0]);return(a[0]<0)});define_libfunc("odd?",1,1,function(a){assert_number(a[0]);return(a[0]%2==1)||(a[0]%2==-1)});define_libfunc("even?",1,1,function(a){assert_number(a[0]);return a[0]%2==0});define_libfunc("finite?",1,1,function(a){assert_number(a[0]);return(a[0]!=Infinity)&&(a[0]!=-Infinity)&&!isNaN(a[0])});define_libfunc("infinite?",1,1,function(a){assert_number(a[0]);return(a[0]==Infinity)||(a[0]==-Infinity)});define_libfunc("nan?",1,1,function(a){assert_number(a[0]);return isNaN(a[0])});define_libfunc("max",2,null,function(a){for(var c=0;c<a.length;c++){assert_number(a[c])}return Math.max.apply(null,a)});define_libfunc("min",2,null,function(a){for(var c=0;c<a.length;c++){assert_number(a[c])}return Math.min.apply(null,a)});define_libfunc("+",0,null,function(a){var d=0;for(var c=0;c<a.length;c++){assert_number(a[c]);d+=a[c]}return d});define_libfunc("*",0,null,function(a){var d=1;for(var c=0;c<a.length;c++){assert_number(a[c]);d*=a[c]}return d});define_libfunc("-",1,null,function(c){var a=c.length;assert_number(c[0]);if(a==1){return -c[0]}else{var e=c[0];for(var d=1;d<a;d++){assert_number(c[d]);e-=c[d]}return e}});define_libfunc("/",1,null,function(c){var a=c.length;assert_number(c[0]);if(a==1){return 1/c[0]}else{var e=c[0];for(var d=1;d<a;d++){assert_number(c[d]);e/=c[d]}return e}});define_libfunc("abs",1,1,function(a){assert_number(a[0]);return Math.abs(a[0])});var div=function(c,a){return Math.floor(c/a)};var mod=function(c,a){return c-Math.floor(c/a)*a};var div0=function(c,a){return(c>0)?Math.floor(c/a):Math.ceil(c/a)};var mod0=function(c,a){return(c>0)?c-Math.floor(c/a)*a:c-Math.ceil(c/a)*a};define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div(a[0],a[1]),mod(a[0],a[1])])});define_libfunc("div",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div(a[0],a[1])});define_libfunc("mod",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return mod(a[0],a[1])});define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div0(a[0],a[1]),mod0(a[0],a[1])])});define_libfunc("div0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div0(a[0],a[1])});define_libfunc("mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return mod0(a[0],a[1])});define_libfunc("numerator",1,1,function(a){assert_number(a[0]);if(a[0] instanceof Rational){return a[0].numerator}else{throw new Bug("todo")}});define_libfunc("denominator",1,1,function(a){assert_number(a[0]);if(a[0] instanceof Rational){return a[0].denominator}else{throw new Bug("todo")}});define_libfunc("floor",1,1,function(a){assert_number(a[0]);return Math.floor(a[0])});define_libfunc("ceiling",1,1,function(a){assert_number(a[0]);return Math.ceil(a[0])});define_libfunc("truncate",1,1,function(a){assert_number(a[0]);return(a[0]<0)?Math.ceil(a[0]):Math.floor(a[0])});define_libfunc("round",1,1,function(a){assert_number(a[0]);return Math.round(a[0])});define_libfunc("exp",1,1,function(a){assert_number(a[0]);return Math.exp(a[0])});define_libfunc("log",1,2,function(a){var c=a[0],d=a[1];assert_number(c);if(d){assert_number(d);return Math.log(c)/Math.log(b)}else{return Math.log(c)}});define_libfunc("sin",1,1,function(a){assert_number(a[0]);return Math.sin(a[0])});define_libfunc("cos",1,1,function(a){assert_number(a[0]);return Math.cos(a[0])});define_libfunc("tan",1,1,function(a){assert_number(a[0]);return Math.tan(a[0])});define_libfunc("asin",1,1,function(a){assert_number(a[0]);return Math.asin(a[0])});define_libfunc("acos",1,1,function(a){assert_number(a[0]);return Math.acos(a[0])});define_libfunc("atan",1,2,function(a){assert_number(a[0]);if(a[1]){assert_number(a[1]);return Math.atan2(a[0],a[1])}else{return Math.atan(a[0])}});define_libfunc("sqrt",1,1,function(a){assert_number(a[0]);return Math.sqrt(a[0])});define_libfunc("exact-integer-sqrt",1,1,function(c){assert_number(c[0]);var a=Math.sqrt(c[0]);var e=a-(a%1);var d=c[0]-e*e;return new Values([e,d])});define_libfunc("expt",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Math.pow(a[0],a[1])});define_libfunc("make-rectangular",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Complex(a[0],a[1])});define_libfunc("make-polar",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Complex.from_polar(a[0],a[1])});define_libfunc("real-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).real});define_libfunc("imag-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).imag});define_libfunc("magnitude",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).magnitude()});define_libfunc("angle",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).angle()});define_libfunc("number->string",1,3,function(c){var e=c[0],d=c[1],a=c[2];if(a){throw new Bug("number->string: precision is not yet implemented")}d=d||10;return e.toString(d)});define_libfunc("string->number",1,3,function(a){var d=a[0],c=a[1]||10;switch(d){case"+inf.0":return Infinity;case"-inf.0":return -Infinity;case"+nan.0":return NaN;default:if(/[eE.]/.match(d)){return parseFloat(d)}else{return parseInt(d,c)}}});define_libfunc("not",1,1,function(a){return(a[0]===false)?true:false});define_libfunc("boolean?",1,1,function(a){return(a[0]===false||a[0]===true)?true:false});define_libfunc("boolean=?",2,null,function(c){var a=c.length;for(var d=1;d<a;d++){if(c[d]!=c[0]){return false}}return true});define_libfunc("pair?",1,1,function(a){return(a[0] instanceof Pair)?true:false});define_libfunc("cons",2,2,function(a){return new Pair(a[0],a[1])});define_libfunc("car",1,1,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply car on "+a[0])}return a[0].car});define_libfunc("cdr",1,1,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply cdr on "+a[0])}return a[0].cdr});define_libfunc("set-car!",2,2,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply set-car! on "+a[0])}a[0].car=a[1];return BiwaScheme.undef});define_libfunc("set-cdr!",2,2,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply set-cdr! on "+a[0])}a[0].cdr=a[1];return BiwaScheme.undef});define_libfunc("caar",1,1,function(a){return a[0].car.car});define_libfunc("cadr",1,1,function(a){return a[0].cdr.car});define_libfunc("cdar",1,1,function(a){return a[0].car.cdr});define_libfunc("cddr",1,1,function(a){return a[0].cdr.cdr});define_libfunc("caaar",1,1,function(a){return a[0].car.car.car});define_libfunc("caadr",1,1,function(a){return a[0].cdr.car.car});define_libfunc("cadar",1,1,function(a){return a[0].car.cdr.car});define_libfunc("caddr",1,1,function(a){return a[0].cdr.cdr.car});define_libfunc("cdaar",1,1,function(a){return a[0].car.car.cdr});define_libfunc("cdadr",1,1,function(a){return a[0].cdr.car.cdr});define_libfunc("cddar",1,1,function(a){return a[0].car.cdr.cdr});define_libfunc("cdddr",1,1,function(a){return a[0].cdr.cdr.cdr});define_libfunc("caaaar",1,1,function(a){return a[0].car.car.car.car});define_libfunc("caaadr",1,1,function(a){return a[0].cdr.car.car.car});define_libfunc("caadar",1,1,function(a){return a[0].car.cdr.car.car});define_libfunc("caaddr",1,1,function(a){return a[0].cdr.cdr.car.car});define_libfunc("cadaar",1,1,function(a){return a[0].car.car.cdr.car});define_libfunc("cadadr",1,1,function(a){return a[0].cdr.car.cdr.car});define_libfunc("caddar",1,1,function(a){return a[0].car.cdr.cdr.car});define_libfunc("cadddr",1,1,function(a){return a[0].cdr.cdr.cdr.car});define_libfunc("cdaaar",1,1,function(a){return a[0].car.car.car.cdr});define_libfunc("cdaadr",1,1,function(a){return a[0].cdr.car.car.cdr});define_libfunc("cdadar",1,1,function(a){return a[0].car.cdr.car.cdr});define_libfunc("cdaddr",1,1,function(a){return a[0].cdr.cdr.car.cdr});define_libfunc("cddaar",1,1,function(a){return a[0].car.car.cdr.cdr});define_libfunc("cddadr",1,1,function(a){return a[0].cdr.car.cdr.cdr});define_libfunc("cdddar",1,1,function(a){return a[0].car.cdr.cdr.cdr});define_libfunc("cddddr",1,1,function(a){return a[0].cdr.cdr.cdr.cdr});define_libfunc("null?",1,1,function(a){return(a[0]===nil)});define_libfunc("list?",1,1,function(a){var c=[];for(var d=a[0];d!=nil;d=d.cdr){if(d==nil){return true}if(!(d instanceof Pair)){return false}if(c.find(function(e){return e===d.car})){return false}c.push(d.car)}return true});define_libfunc("list",0,null,function(c){var a=nil;for(var d=c.length-1;d>=0;d--){a=new Pair(c[d],a)}return a});define_libfunc("length",1,1,function(a){assert_list(a[0]);var d=0;for(var c=a[0];c!=nil;c=c.cdr){d++}return d});define_libfunc("append",2,null,function(c){var a=c.length;var d=c[--a];while(a--){c[a].to_array().reverse().each(function(e){d=new Pair(e,d)})}return d});define_libfunc("reverse",1,1,function(c){if(!c[0] instanceof Pair){throw new Error("reverse needs pair but got "+c[0])}var a=nil;for(var d=c[0];d!=nil;d=d.cdr){a=new Pair(d.car,a)}return a});define_libfunc("list-tail",2,2,function(a){if(!a[0] instanceof Pair){throw new Error("list-tail needs pair but got "+a[0])}var d=a[0];for(var c=0;c<a[1];c++){if(!d instanceof Pair){throw new Error("list-tail: the list is shorter than "+a[1])}d=d.cdr}return d});define_libfunc("list-ref",2,2,function(a){if(!a[0] instanceof Pair){throw new Error("list-ref needs pair but got "+a[0])}var d=a[0];for(var c=0;c<a[1];c++){if(!d instanceof Pair){throw new Error("list-ref: the list is shorter than "+a[1])}d=d.cdr}return d.car});define_libfunc("map",2,null,function(f){var e=f.shift(),c=f;c.each(function(a){assert_list(a)});var d=[];return Call.multi_foreach(c,{call:function(a){return new Call(e,a.map(function(g){return g.car}))},result:function(a){d.push(a)},finish:function(){return d.to_list()}})});define_libfunc("for-each",2,null,function(d){var c=d.shift(),a=d;a.each(function(e){assert_list(e)});return Call.multi_foreach(a,{call:function(e){return new Call(c,e.map(function(f){return f.car}))},finish:function(){return BiwaScheme.undef}})});define_libfunc("symbol?",1,1,function(a){return(a[0] instanceof Symbol)?true:false});define_libfunc("symbol->string",1,1,function(a){assert_symbol(a[0]);return a[0].name});define_libfunc("symbol=?",2,null,function(a){assert_symbol(a[0]);for(var c=1;c<a.length;c++){assert_symbol(a[c]);if(a[c]!=a[0]){return false}}return true});define_libfunc("string->symbol",1,1,function(a){assert_string(a[0]);return Sym(a[0])});define_libfunc("char?",1,1,function(a){return(a[0] instanceof Char)});define_libfunc("char->integer",1,1,function(a){assert_char(a[0]);return a[0].value.charCodeAt(0)});define_libfunc("integer->char",1,1,function(a){assert_integer(a[0]);return Char.get(String.fromCharCode(a[0]))});var make_char_compare_func=function(a){return function(c){assert_char(c[0]);for(var d=1;d<c.length;d++){assert_char(c[d]);if(!a(c[d-1].value,c[d].value)){return false}}return true}};define_libfunc("char=?",2,null,make_char_compare_func(function(d,c){return d==c}));define_libfunc("char<?",2,null,make_char_compare_func(function(d,c){return d<c}));define_libfunc("char>?",2,null,make_char_compare_func(function(d,c){return d>c}));define_libfunc("char<=?",2,null,make_char_compare_func(function(d,c){return d<=c}));define_libfunc("char>=?",2,null,make_char_compare_func(function(d,c){return d>=c}));define_libfunc("string?",1,1,function(a){return(typeof(a[0])=="string")});define_libfunc("make-string",1,2,function(a){assert_integer(a[0]);var d=" ";if(a[1]){assert_char(a[1]);d=a[1].value}return d.times(a[0])});define_libfunc("string",1,null,function(a){for(var c=0;c<a.length;c++){assert_char(a[c])}return a.map(function(d){return d.value}).join("")});define_libfunc("string-length",1,1,function(a){assert_string(a[0]);return a[0].length});define_libfunc("string-ref",2,2,function(a){assert_string(a[0]);assert_between(a[1],0,a[0].length-1);return Char.get(a[0].charAt([a[1]]))});define_libfunc("string=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(a[0]!=a[c]){return false}}return true});define_libfunc("string<?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]<a[c])){return false}}return true});define_libfunc("string>?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]>a[c])){return false}}return true});define_libfunc("string<=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]<=a[c])){return false}}return true});define_libfunc("string>=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]>=a[c])){return false}}return true});define_libfunc("substring",3,3,function(a){assert_string(a[0]);assert_integer(a[1]);assert_integer(a[2]);if(a[1]<0){throw new Error("substring: start too small: "+a[1])}if(a[2]<0){throw new Error("substring: end too small: "+a[2])}if(a[0].length+1<=a[1]){throw new Error("substring: start too big: "+a[1])}if(a[0].length+1<=a[2]){throw new Error("substring: end too big: "+a[2])}if(!(a[1]<=a[2])){throw new Error("substring: not start <= end: "+a[1]+", "+a[2])}return a[0].substring(a[1],a[2])});define_libfunc("string-append",0,null,function(a){for(var c=0;c<a.length;c++){assert_string(a[c])}return a.join("")});define_libfunc("string->list",1,1,function(a){assert_string(a[0]);var c=[];a[0].scan(/./,function(d){c.push(Char.get(d[0]))});return c.to_list()});define_libfunc("list->string",1,1,function(a){assert_list(a[0]);return a[0].to_array().map(function(d){return d.value}).join("")});define_libfunc("string-for-each",2,null,function(c){var a=c.shift(),d=c;d.each(function(e){assert_string(e)});return Call.multi_foreach(d,{call:function(e){return new Call(a,e)},finish:function(){return BiwaScheme.undef}})});define_libfunc("string-copy",1,1,function(a){assert_string(a[0]);return a[0]});define_libfunc("vector?",1,1,function(a){return(a[0] instanceof Array)&&(a[0].closure_p!==true)});define_libfunc("make-vector",1,2,function(a){assert_integer(a[0]);var d=new Array(a[0]);if(a.length==2){for(var c=0;c<a[0];c++){d[c]=a[1]}}return d});define_libfunc("vector",1,null,function(a){return a});define_libfunc("vector-length",1,1,function(a){assert_vector(a[0]);return a[0].length});define_libfunc("vector-ref",2,2,function(a){assert_vector(a[0]);assert_integer(a[1]);return a[0][a[1]]});define_libfunc("vector-set!",3,3,function(a){assert_vector(a[0]);assert_integer(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc("vector->list",1,1,function(a){assert_vector(a[0]);return a[0].to_list()});define_libfunc("list->vector",1,1,function(a){assert_list(a[0]);return a[0].to_array()});define_libfunc("vector-fill!",2,2,function(a){assert_vector(a[0]);var d=a[0],e=a[1];for(var c=0;c<d.length;c++){d[c]=e}return d});define_libfunc("vector-map",2,null,function(e){var d=e.shift(),f=e;f.each(function(a){assert_vector(a)});var c=[];return Call.multi_foreach(f,{call:function(a){return new Call(d,a)},result:function(a){c.push(a)},finish:function(){return c}})});define_libfunc("vector-for-each",2,null,function(c){var a=c.shift(),d=c;d.each(function(e){assert_vector(e)});return Call.multi_foreach(d,{call:function(e){return new Call(a,e)},finish:function(){return BiwaScheme.undef}})});define_libfunc("apply",2,null,function(c){var a=c.shift(),e=c.pop(),d=c;d=d.concat(e.to_array());return new Call(a,d)});define_syntax("call-with-current-continuation",function(a){return new Pair(Sym("call/cc"),a.cdr)});define_libfunc("values",0,null,function(a){return new Values(a)});define_libfunc("call-with-values",2,2,function(c){var a=c[0],d=c[1];return new Call(a,[],function(f){var e=f[0];if(!(e instanceof Values)){throw new Error("values expected, but got "+to_write(e))}return new Call(d,e.content)})});var expand_qq=function(c,d){if(c instanceof Symbol||c===nil){return[Sym("quote"),c].to_list()}else{if(c instanceof Pair){var a=c.car;if(a instanceof Pair&&a.car===Sym("unquote-splicing")){var d=d-1;if(d==0){return[Sym("append"),c.car.cdr.car,expand_qq(c.cdr,d+1)].to_list()}else{return[Sym("cons"),[Sym("list"),Sym("unquote-splicing"),expand_qq(c.car.cdr.car,d)].to_list(),expand_qq(c.cdr,d+1)].to_list()}}else{if(a===Sym("unquote")){var d=d-1;if(d==0){return c.cdr.car}else{return[Sym("list"),[Sym("quote"),Sym("unquote")].to_list(),expand_qq(c.cdr.car,d)].to_list()}}else{if(a===Sym("quasiquote")){return[Sym("list"),Sym("quasiquote"),expand_qq(c.cdr.car,d+1)].to_list()}else{return[Sym("cons"),expand_qq(c.car,d),expand_qq(c.cdr,d)].to_list()}}}}else{if(c instanceof Array){throw new Bug("vector quasiquotation is not implemented yet")}else{return c}}}};define_syntax("quasiquote",function(a){return expand_qq(a.cdr.car,1)});define_syntax("unquote",function(a){throw new Error("unquote(,) must be inside quasiquote(`)")});define_syntax("unquote-splicing",function(a){throw new Error("unquote-splicing(,@) must be inside quasiquote(`)")});define_libfunc("string-upcase",1,1,function(a){assert_string(a[0]);return a[0].toUpperCase()});define_libfunc("string-downcase",1,1,function(a){assert_string(a[0]);return a[0].toLowerCase()});BiwaScheme.make_string_ci_function=function(a){return function(c){assert_string(c[0]);var e=c[0].toUpperCase();for(var d=1;d<c.length;d++){assert_string(c[d]);if(!a(e,c[d].toUpperCase())){return false}}return true}};define_libfunc("string-ci=?",2,null,make_string_ci_function(function(d,c){return d==c}));define_libfunc("string-ci<?",2,null,make_string_ci_function(function(d,c){return d<c}));define_libfunc("string-ci>?",2,null,make_string_ci_function(function(d,c){return d>c}));define_libfunc("string-ci<=?",2,null,make_string_ci_function(function(d,c){return d<=c}));define_libfunc("string-ci>=?",2,null,make_string_ci_function(function(d,c){return d>=c}));define_libfunc("find",2,2,function(d){var c=d[0],a=d[1];assert_list(a);return Call.foreach(a,{call:function(e){return new Call(c,[e.car])},result:function(f,e){if(f){return e.car}},finish:function(){return false}})});define_libfunc("for-all",2,null,function(d){var c=d.shift();var a=d;a.each(function(f){assert_list(f)});var e=true;return Call.multi_foreach(a,{call:function(f){return new Call(c,f.map(function(g){return g.car}))},result:function(f,g){if(f===false){return false}e=f},finish:function(){return e}})});define_libfunc("exists",2,null,function(d){var c=d.shift();var a=d;a.each(function(e){assert_list(e)});return Call.multi_foreach(a,{call:function(e){return new Call(c,e.map(function(f){return f.car}))},result:function(e,f){if(e!==false){return e}},finish:function(){return false}})});define_libfunc("filter",2,2,function(f){var e=f[0],d=f[1];assert_list(d);var c=[];return Call.foreach(d,{call:function(a){return new Call(e,[a.car])},result:function(g,a){if(g){c.push(a.car)}},finish:function(){return c.to_list()}})});define_libfunc("partition",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[],g=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(h,f){if(h){e.push(f.car)}else{g.push(f.car)}},finish:function(){return new Values([e.to_list(),g.to_list()])}})});define_libfunc("fold-left",3,null,function(e){var c=e.shift(),d=e.shift(),a=e;a.each(function(f){assert_list(f)});return Call.multi_foreach(a,{call:function(g){var f=g.map(function(h){return h.car});f.unshift(d);return new Call(c,f)},result:function(f,g){d=f},finish:function(){return d}})});define_libfunc("fold-right",3,null,function(e){var c=e.shift(),d=e.shift();var a=e.map(function(f){assert_list(f);return f.to_array().reverse().to_list()});return Call.multi_foreach(a,{call:function(g){var f=g.map(function(h){return h.car});f.push(d);return new Call(c,f)},result:function(f,g){d=f},finish:function(){return d}})});define_libfunc("remp",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(g,f){if(!g){e.push(f.car)}},finish:function(){return e.to_list()}})});var make_remover=function(a){return function(d){var f=d[0],c=d[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(g){return new Call(TopEnv[a]||CoreEnv[a],[f,g.car])},result:function(h,g){if(!h){e.push(g.car)}},finish:function(){return e.to_list()}})}};define_libfunc("remove",2,2,make_remover("equal?"));define_libfunc("remv",2,2,make_remover("eqv?"));define_libfunc("remq",2,2,make_remover("eq?"));define_libfunc("memp",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(g,f){if(g){return f}},finish:function(){return false}})});var make_finder=function(a){return function(d){var f=d[0],c=d[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(g){return new Call(TopEnv[a]||CoreEnv[a],[f,g.car])},result:function(h,g){if(h){return g}},finish:function(){return false}})}};define_libfunc("member",2,2,make_finder("equal?"));define_libfunc("memv",2,2,make_finder("eqv?"));define_libfunc("memq",2,2,make_finder("eq?"));define_libfunc("assp",2,2,function(c){var a=c[0],e=c[1];assert_list(e);var d=[];return Call.foreach(e,{call:function(f){if(f.car.car){return new Call(a,[f.car.car])}else{throw new Error("ass*: pair required but got "+to_write(f.car))}},result:function(g,f){if(g){return f.car}},finish:function(){return false}})});var make_assoc=function(a){return function(d){var f=d[0],c=d[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(g){if(g.car.car){return new Call(TopEnv[a]||CoreEnv[a],[f,g.car.car])}else{throw new Error("ass*: pair required but got "+to_write(g.car))}},result:function(h,g){if(h){return g.car}},finish:function(){return false}})}};define_libfunc("assoc",2,2,make_assoc("equal?"));define_libfunc("assv",2,2,make_assoc("eqv?"));define_libfunc("assq",2,2,make_assoc("eq?"));define_libfunc("cons*",1,null,function(a){if(a.length==1){return a[0]}else{var c=null;a.reverse().each(function(d){if(c){c=new Pair(d,c)}else{c=d}});return c}});define_libfunc("list-sort",1,2,function(a){if(a[1]){throw new Bug("list-sort: cannot take compare proc now")}assert_list(a[0]);return a[0].to_array().sort().to_list()});define_libfunc("vector-sort",1,2,function(a){if(a[1]){throw new Bug("list-sort: cannot take compare proc now")}assert_vector(a[0]);return a[0].clone().sort()});define_libfunc("vector-sort!",1,2,function(a){if(a[1]){throw new Bug("list-sort: cannot take compare proc now")}assert_vector(a[0]);a[0].sort();return BiwaScheme.undef});define_syntax("when",function(c){var d=c.cdr.car,a=c.cdr.cdr;return new Pair(Sym("if"),new Pair(d,new Pair(new Pair(Sym("begin"),a),new Pair(BiwaScheme.undef,nil))))});define_syntax("unless",function(c){var d=c.cdr.car,a=c.cdr.cdr;return new Pair(Sym("if"),new Pair(new Pair(Sym("not"),new Pair(d,nil)),new Pair(new Pair(Sym("begin"),a),new Pair(BiwaScheme.undef,nil))))});define_syntax("do",function(h){if(!BiwaScheme.isPair(h.cdr)){throw new Error("do: no variables of do")}var l=h.cdr.car;if(!BiwaScheme.isPair(l)){throw new Error("do: variables must be given as a list")}if(!BiwaScheme.isPair(h.cdr.cdr)){throw new Error("do: no resulting form of do")}var a=h.cdr.cdr.car;var k=h.cdr.cdr.cdr;var d=BiwaScheme.gensym();var e=l.map(function(o){var m=o.to_array();return List(m[0],m[1])}).to_list();var f=a.car;var g=new Pair(Sym("begin"),a.cdr);var c=new Pair(d,l.map(function(o){var m=o.to_array();return m[2]||m[0]}).to_list());var j=new Pair(Sym("begin"),k).concat(List(c));return List(Sym("let"),d,e,List(Sym("if"),f,g,j))});define_syntax("case-lambda",function(a){});define_syntax("define-record-type",function(o){var t=o.cdr.car;var w=o.cdr.cdr;if(BiwaScheme.isSymbol(t)){var f=t;var A=Sym("make-"+t.name);var d=Sym(t.name+"?")}else{assert_list(t);var f=t.car;var A=t.cdr.car;var d=t.cdr.cdr.car;assert_symbol(f);assert_symbol(A);assert_symbol(d)}var z=false;var k=false;var a=false;var j=false;var g;var c=false;var s=false;var q=false;var u=[];w.to_array().each(function(x){switch(x.car){case Sym("fields"):u=x.cdr.to_array().map(function(C,B){if(BiwaScheme.isSymbol(C)){return{name:C,idx:B,mutable:false,accessor_name:null,mutator_name:null}}else{assert_list(C);assert_symbol(C.car);switch(C.car){case Sym("immutable"):var D=C.cdr.car;assert_symbol(D);if(BiwaScheme.isNil(C.cdr.cdr)){return{name:D,idx:B,mutable:false}}else{return{name:D,idx:B,mutable:false,accessor_name:C.cdr.cdr.car}}break;case Sym("mutable"):var D=C.cdr.car;assert_symbol(D);if(BiwaScheme.isNil(C.cdr.cdr)){return{name:D,idx:B,mutable:true}}else{return{name:D,idx:B,mutable:true,accessor_name:C.cdr.cdr.car,mutator_name:C.cdr.cdr.cdr.car}}break;default:throw new Error("define-record-type: field definition must start with `immutable' or 'mutable'")}}});break;case Sym("parent"):g=x.cdr.car;assert_symbol(g);break;case Sym("protocol"):q=x.cdr.car;break;case Sym("sealed"):z=!!x.cdr.car;break;case Sym("opaque"):k=!!x.cdr.car;break;case Sym("nongenerative"):a=true;j=x.cdr.car;break;case Sym("parent-rtd"):c=x.cdr.car;s=x.cdr.cdr.car;break;default:throw new BiwaScheme.Error("define-record-type: unknown clause `"+BiwaScheme.to_write(x.car)+"'")}});if(g){c=[Sym("record-type-descriptor"),g];s=[Sym("record-constructor-descriptor"),g]}var m=[Sym("record-type-descriptor"),f];var r=[Sym("record-constructor-descriptor"),f];var y=u.map(function(x){return BiwaScheme.build_list([Sym(x.mutable?"mutable":"immutable"),x.name])});y.is_vector=true;var v=[Sym("make-record-type-descriptor"),[Sym("quote"),f],c,j,z,k,y];var p=[Sym("make-record-constructor-descriptor"),Sym("__rtd"),s,q];var h=[Sym("let*"),[[Sym("__rtd"),v],[Sym("__cd"),p]],[Sym("_define-record-type"),[Sym("quote"),f],Sym("__rtd"),Sym("__cd")]];var l=u.map(function(B){var x=B.accessor_name||Sym(f.name+"-"+B.name.name);return[Sym("define"),x,[Sym("record-accessor"),m,B.idx]]});var e=u.findAll(function(x){return x.mutable}).map(function(B){var x=B.mutator_name||Sym("set-"+f.name+"-"+B.name.name+"!");return[Sym("define"),x,[Sym("record-mutator"),m,B.idx]]});return BiwaScheme.build_list([Sym("begin"),h,[Sym("define"),A,[Sym("record-constructor"),r]],[Sym("define"),d,[Sym("record-predicate"),m]],].concat(l).concat(e))});define_libfunc("_define-record-type",3,3,function(a){assert_symbol(a[0]);assert_record_td(a[1]);assert_record_cd(a[2]);BiwaScheme.Record.define_type(a[0].name,a[1],a[2]);return BiwaScheme.undef});define_syntax("record-type-descriptor",function(a){return BiwaScheme.build_list([Sym("_record-type-descriptor"),[Sym("quote"),a.cdr.car]])});define_libfunc("_record-type-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c){return c.rtd}else{throw new Error("record-type-descriptor: unknown record type "+a[0].name)}});define_syntax("record-constructor-descriptor",function(a){return BiwaScheme.build_list([Sym("_record-constructor-descriptor"),[Sym("quote"),a.cdr.car]])});define_libfunc("_record-constructor-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c){return c.cd}else{throw new Error("record-constructor-descriptor: unknown record type "+a[0].name)}});define_libfunc("make-record-type-descriptor",6,6,function(g){var c=g[0],d=g[1],l=g[2],e=g[3],j=g[4],k=g[5];assert_symbol(c);if(d){assert_record_td(d)}if(l){assert_symbol(l);var f=BiwaScheme.Record.RTD.NongenerativeRecords.get(l.name);if(f){return f}}e=!!e;j=!!j;assert_vector(k);for(var h=0;h<k.length;h++){var m=k[h];assert_symbol(m.car,"mutability");assert_symbol(m.cdr.car,"field name");k[h]=[m.cdr.car.name,(m.car==Sym("mutable"))]}var a=new BiwaScheme.Record.RTD(c,d,l,e,j,k);if(l){BiwaScheme.Record.RTD.NongenerativeRecords.set(l.name,a)}return a});define_libfunc("record-type-descriptor?",1,1,function(a){return(a[0] instanceof BiwaScheme.Record.RTD)});define_libfunc("make-record-constructor-descriptor",3,3,function(a){var c=a[0],d=a[1],e=a[2];assert_record_td(c);if(d){assert_record_cd(d)}if(e){assert_procedure(e)}return new BiwaScheme.Record.CD(c,d,e)});define_libfunc("record-constructor",1,1,function(a){var c=a[0];assert_record_cd(c);return c.record_constructor()});define_libfunc("record-predicate",1,1,function(a){var c=a[0];assert_record_td(c);return function(d){var e=d[0];return(e instanceof BiwaScheme.Record)&&(e.rtd===c)}});define_libfunc("record-accessor",2,2,function(c){var d=c[0],a=c[1];assert_record_td(d);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return function(g){var f=g[0];assert_record(f);var h=false;for(var j=f.rtd;j;j=j.parent_rtd){if(j==d){h=true}}assert(h,"(record-accessor): "+BiwaScheme.to_write(f)+" is not a "+d.name);return f.get(a)}});define_libfunc("record-mutator",2,2,function(c){var d=c[0],a=c[1];assert_record_td(d);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return function(g){var f=g[0],h=g[1];assert_record(f);assert(f.rtd===d,"(record-mutator): "+BiwaScheme.to_write(f)+" is not a "+d.name);assert(!f.rtd.sealed,"(record-mutator): "+d.name+" is sealed (can't mutate)");f.set(a,h)}});define_libfunc("record?",1,1,function(a){var c=a[0];if(BiwaScheme.isRecord(c)){if(c.rtd.opaque){return false}else{return true}}else{return false}});define_libfunc("record-rtd",1,1,function(a){assert_record(a[0]);return a[0].rtd});define_libfunc("record-type-name",1,1,function(a){assert_record_td(a[0]);return a[0].name});define_libfunc("record-type-parent",1,1,function(a){assert_record_td(a[0]);return a[0].parent_rtd});define_libfunc("record-type-uid",1,1,function(a){assert_record_td(a[0]);return a[0].uid});define_libfunc("record-type-generative?",1,1,function(a){assert_record_td(a[0]);return a[0].generative});define_libfunc("record-type-sealed?",1,1,function(a){assert_record_td(a[0]);return a[0].sealed});define_libfunc("record-type-opaque?",1,1,function(a){assert_record_td(a[0]);return a[0].opaque});define_libfunc("record-type-field-names",1,1,function(a){assert_record_td(a[0]);return a[0].fields.map(function(c){return c.name})});define_libfunc("record-field-mutable?",2,2,function(c){var d=c[0],a=c[1];assert_record_td(c[0]);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return c[0].fields[a].mutable});define_libfunc("raise",1,1,function(a){throw new BiwaScheme.UserError(BiwaScheme.to_write(a[0]))});define_libfunc("port?",1,1,function(a){return(a[0] instanceof Port)});define_libfunc("textual-port?",1,1,function(a){assert_port(a[0]);return !a[0].is_binary});define_libfunc("binary-port?",1,1,function(a){assert_port(a[0]);return a[0].is_binary});define_libfunc("close-port",1,1,function(a){assert_port(a[0]);a[0].close();return BiwaScheme.undef});define_libfunc("call-with-port",2,2,function(d){var c=d[0],a=d[1];assert_port(c);assert_closure(a);return new Call(a,[c],function(e){c.close();return e[0]})});define_libfunc("put-char",2,2,function(a){assert_port(a[0]);assert_char(a[1]);a[0].put_string(a[1].value);return BiwaScheme.undef});define_libfunc("put-string",2,2,function(a){assert_port(a[0]);assert_string(a[1]);a[0].put_string(a[1]);return BiwaScheme.undef});define_libfunc("put-datum",2,2,function(a){assert_port(a[0]);a[0].put_string(to_write(a[1]));return BiwaScheme.undef});define_libfunc("eof-object",0,0,function(a){return eof});define_libfunc("eof-object?",1,1,function(a){return a[0]===eof});define_libfunc("input-port?",1,1,function(a){assert_port(a[0]);return a[0].is_input});define_libfunc("output-port?",1,1,function(a){assert_port(a[0]);return a[0].is_output});define_libfunc("current-input-port",0,0,function(a){return Port.current_input});define_libfunc("current-output-port",0,0,function(a){return Port.current_output});define_libfunc("current-error-port",0,0,function(a){return Port.current_error});define_libfunc("close-input-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_input){throw new Error("close-input-port: port is not input port")}a[0].close();return BiwaScheme.undef});define_libfunc("close-output-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_output){throw new Error("close-output-port: port is not output port")}a[0].close();return BiwaScheme.undef});define_libfunc("read",0,1,function(c){var a=c[0]||Port.current_input;assert_port(a);return a.get_string(function(d){return Interpreter.read(d)})});define_libfunc("newline",0,1,function(c){var a=c[0]||Port.current_output;a.put_string("\n");return BiwaScheme.undef});define_libfunc("display",1,2,function(c){var a=c[1]||Port.current_output;a.put_string(to_display(c[0]));return BiwaScheme.undef});define_libfunc("write",1,2,function(c){var a=c[1]||Port.current_output;assert_port(a);a.put_string(to_write(c[0]));return BiwaScheme.undef});define_libfunc("file-exists?",1,1,function(c){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(c[0]);var a=FileIO.open(c[0]);return a.exists()});define_libfunc("delete-file",1,1,function(c){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(c[0]);var a=FileIO.unlink(FileIO.open(c[0]));if(!a){BiwaScheme.Port.current_output.put_string("delete-file: cannot delete "+c[0])}return BiwaScheme.undef});define_libfunc("make-eq-hashtable",0,1,function(a){return new Hashtable(Hashtable.eq_hash,Hashtable.eq_equiv)});define_libfunc("make-eqv-hashtable",0,1,function(a){return new Hashtable(Hashtable.eqv_hash,Hashtable.eqv_equiv)});define_libfunc("make-hashtable",2,3,function(a){assert_procedure(a[0]);assert_procedure(a[1]);return new Hashtable(a[0],a[1])});define_libfunc("hashtable?",1,1,function(a){return a[0] instanceof Hashtable});define_libfunc("hashtable-size",1,1,function(a){assert_hashtable(a[0]);return a[0].keys().length});BiwaScheme.find_hash_pair=function(d,a,c){return new Call(d.hash_proc,[a],function(e){var g=e[0];var f=d.candidate_pairs(g);if(!f){return c.on_not_found(g)}return Call.foreach(f,{call:function(h){return new Call(d.equiv_proc,[a,h[0]])},result:function(h,j){if(h){return c.on_found(j,g)}},finish:function(){return c.on_not_found(g)}})})};define_libfunc("hashtable-ref",3,3,function(a){var e=a[0],c=a[1],d=a[2];assert_hashtable(e);return BiwaScheme.find_hash_pair(e,c,{on_found:function(f){return f[1]},on_not_found:function(f){return d}})});define_libfunc("hashtable-set!",3,3,function(a){var e=a[0],c=a[1],d=a[2];assert_hashtable(e);return BiwaScheme.find_hash_pair(e,c,{on_found:function(f){f[1]=d;return BiwaScheme.undef},on_not_found:function(f){e.add_pair(f,c,d);return BiwaScheme.undef}})});define_libfunc("hashtable-delete!",2,2,function(a){var d=a[0],c=a[1];assert_hashtable(d);return BiwaScheme.find_hash_pair(d,c,{on_found:function(f,e){d.remove_pair(e,f);return BiwaScheme.undef},on_not_found:function(e){return BiwaScheme.undef}})});define_libfunc("hashtable-contains?",2,2,function(a){var d=a[0],c=a[1];assert_hashtable(d);return BiwaScheme.find_hash_pair(d,c,{on_found:function(e){return true},on_not_found:function(e){return false}})});define_libfunc("hashtable-update!",4,4,function(c){var f=c[0],d=c[1],a=c[2],e=c[3];assert_hashtable(f);assert_procedure(a);return BiwaScheme.find_hash_pair(f,d,{on_found:function(h,g){return new Call(a,[h[1]],function(j){h[1]=j[0];return BiwaScheme.undef})},on_not_found:function(g){return new Call(a,[e],function(h){f.add_pair(g,d,h[0]);return BiwaScheme.undef})}})});define_libfunc("hashtable-copy",1,2,function(c){var a=(c[1]===undefined)?false:!!c[1];assert_hashtable(c[0]);return c[0].create_copy(a)});define_libfunc("hashtable-clear!",0,1,function(a){assert_hashtable(a[0]);a[0].clear();return BiwaScheme.undef});define_libfunc("hashtable-keys",1,1,function(a){assert_hashtable(a[0]);return a[0].keys()});define_libfunc("hashtable-entries",1,1,function(a){assert_hashtable(a[0]);return new Values([a[0].keys(),a[0].values()])});define_libfunc("hashtable-equivalence-function",1,1,function(a){assert_hashtable(a[0]);return a[0].equiv_proc});define_libfunc("hashtable-hash-function",1,1,function(a){assert_hashtable(a[0]);return a[0].hash_proc});define_libfunc("hashtable-mutable?",1,1,function(a){assert_hashtable(a[0]);return a[0].mutable});define_libfunc("equal-hash",0,0,function(a){return Hashtable.equal_hash});define_libfunc("string-hash",0,0,function(a){return Hashtable.string_hash});define_libfunc("string-ci-hash",0,0,function(a){return Hashtable.string_ci_hash});define_libfunc("symbol-hash",0,0,function(a){return Hashtable.symbol_hash});define_libfunc("eval",1,1,function(c,a){var d=c[0];var a=new BiwaScheme.Interpreter(a.on_error);return a.evaluate(d.to_write())})}if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_libfunc("read-line",0,1,function(c){var a=c[0]||Port.current_input;assert_port(a);return a.get_string()});define_libfunc("element-clear!",1,1,function(a){return $(a[0]).update()});define_libfunc("element-empty!",1,1,function(a){return $(a[0]).update()});define_libfunc("element-visible?",1,1,function(a){return $(a[0]).visible()});define_libfunc("element-toggle!",1,1,function(a){return $(a[0]).toggle()});define_libfunc("element-hide!",1,1,function(a){return $(a[0]).hide()});define_libfunc("element-show!",1,1,function(a){return $(a[0]).show()});define_libfunc("element-remove!",1,1,function(a){return $(a[0]).remove("")});define_libfunc("element-update!",2,2,function(a){return $(a[0]).update(a[1])});define_libfunc("element-replace!",2,2,function(a){return $(a[0]).replace(a[1])});define_libfunc("element-insert!",2,2,function(a){return $(a[0]).insert(a[1])});define_libfunc("element-wrap!",3,3,function(a){throw new Bug("not yet implemented")});define_libfunc("element-ancestors",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-descendants",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-first-descendant",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-immediate-descendants",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-previous-sibling",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-next-sibling",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-siblings",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-match?",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-up",3,3,function(a){throw new Bug("not yet implemented")});define_libfunc("element-down",3,3,function(a){throw new Bug("not yet implemented")});define_libfunc("element-previous",3,3,function(a){throw new Bug("not yet implemented")});define_libfunc("element-next",3,3,function(a){throw new Bug("not yet implemented")});define_libfunc("element-select",0,0,function(a){throw new Bug("not yet implemented")});define_libfunc("element-adjacent",0,0,function(a){throw new Bug("not yet implemented")});define_libfunc("element-identify",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-read-attribute",2,2,function(a){assert_string(a[1]);return $(a[0]).readAttribute(a[1])});define_libfunc("element-write-attribute",3,3,function(a){assert_string(a[1]);return $(a[0]).readAttribute(a[1],a[2])});define_libfunc("element-height",1,1,function(a){return $(a[0]).getHeight()});define_libfunc("element-width",1,1,function(a){return $(a[0]).getWidth()});define_libfunc("element-class-names",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-has-class-name?",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-add-class-name",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-remove-class-name",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-toggle-class-name",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-clean-whitespace!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-empty?",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-descendant-of!",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("scroll-to-element!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-style",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-opacity",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-style-set!",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-opacity-set!",2,2,function(a){throw new Bug("not yet implemented")});define_libfunc("element-dimensions",1,1,function(a){var c=$(a[0]).getDimensions();return new Values(c.width,c.height)});define_libfunc("element-make-positioned!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-undo-positioned!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-make-clipping!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-undo-clipping!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-cumulative-offset",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-positioned-offset",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-absolutize!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-relativize!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-cumulative-scroll-offset",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-offset-parent",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-viewport-offset",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-clone-position!",1,1,function(a){throw new Bug("not yet implemented")});define_libfunc("element-absolutize!",1,1,function(a){throw new Bug("not yet implemented")});BiwaScheme.create_elements_by_dom=function(c){var a=function(k,j,l){var h=new Element(k,j);l.each(function(m){h.insert({bottom:m})});return h};var c=c.to_array();var e=c[0].name||c[0];var d={};var g=[];for(var f=1;f<c.length;f++){if(c[f] instanceof Symbol){d[c[f].name]=c[f+1];f++}else{if(c[f] instanceof Pair){g.push(create_elements_by_dom(c[f]))}else{g.push(c[f].toString())}}}return a(e,d,g)};BiwaScheme.create_elements_by_string=function(a){var a=a.to_array();var c=a.shift();if(c instanceof Symbol){c=c.name}if(c.match(/(.*)\.(.*)/)){c=RegExp.$1;a.unshift(Sym("class"),RegExp.$2)}if(c.match(/(.*)\#(.*)/)){c=RegExp.$1;a.unshift(Sym("id"),RegExp.$2)}var e=[];var f=["<"+c];for(var d=0;d<a.length;d++){if(a[d] instanceof Symbol){f.push(" "+a[d].name+'="'+a[d+1]+'"');d++}else{if(a[d] instanceof Pair){e.push(create_elements_by_string(a[d]))}else{e.push(a[d])}}}f.push(">");f.push(e.join(""));f.push("</"+c+">");return f.join("")};BiwaScheme.tree_all=function(a,c){if(a===nil){return true}else{if(c(a.car)===false){return false}else{return BiwaScheme.tree_all(a.cdr,c)}}};define_libfunc("element-new",1,1,function(a){var c=function(e){return Object.isString(e)||(e instanceof Symbol)||(e instanceof Pair)};if(BiwaScheme.tree_all(a[0],c)){var d=new Element("div");d.update(create_elements_by_string(a[0]));return d.firstChild}else{return nil}});define_libfunc("element-content",1,1,function(a){return a[0].value||(a[0].innerHTML).unescapeHTML()});define_libfunc("load",1,1,function(c,a){var d=c[0];assert_string(d);return new BiwaScheme.Pause(function(e){new Ajax.Request(d,{method:"get",evalJSON:false,evalJS:false,onSuccess:function(g){var f=new Interpreter(a.on_error);f.evaluate(g.responseText,function(){return e.resume(BiwaScheme.undef)})},onFailure:function(f){throw new Error("load: network error: failed to load"+d)}})})});define_libfunc("js-load",2,2,function(c){var d=c[0];var a=c[1];assert_string(d);assert_string(a);return new BiwaScheme.Pause(function(e){BiwaScheme.require(d,"window."+a,function(){e.resume(BiwaScheme.undef)})})});BiwaScheme.getelem=function(c){var a=$(c[0]);if(a===undefined||a===null){return false}else{return a}};define_libfunc("$",1,1,BiwaScheme.getelem);define_libfunc("getelem",1,1,BiwaScheme.getelem);define_libfunc("set-style!",3,3,function(a){assert_string(a[1]);a[0].style[a[1]]=a[2];return BiwaScheme.undef});define_libfunc("get-style",2,2,function(a){assert_string(a[1]);return a[0].style[a[1]]});define_libfunc("set-content!",2,2,function(a){assert_string(a[1]);var c=a[1].replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;");a[0].innerHTML=c;return BiwaScheme.undef});define_libfunc("get-content",1,1,function(a){return a[0].value||(a[0].innerHTML).unescapeHTML()});define_libfunc("timer",2,2,function(d,c){var a=d[0],e=d[1];assert_closure(a);assert_real(e);setTimeout(function(){(new Interpreter(c.on_error)).invoke_closure(a)},e*1000);return BiwaScheme.undef});define_libfunc("set-timer!",2,2,function(d,c){var a=d[0],e=d[1];assert_closure(a);assert_real(e);return setInterval(function(){(new Interpreter(c.on_error)).invoke_closure(a)},e*1000)});define_libfunc("clear-timer!",1,1,function(a){var c=a[0];clearInterval(c);return BiwaScheme.undef});define_libfunc("sleep",1,1,function(a){var c=a[0];assert_real(c);return new BiwaScheme.Pause(function(d){setTimeout(function(){d.resume(nil)},c*1000)})});define_libfunc("set-handler!",3,3,function(c,a){throw new Error("set-handler! is obsolete, please use add-handler! instead")});define_libfunc("add-handler!",3,3,function(e,d){var f=e[0],g=e[1],a=e[2];var c=d.on_error;Event.observe(f,g,function(j){var h=new Interpreter(c);h.invoke_closure(a,[j||Window.event])});return BiwaScheme.undef});define_libfunc("wait-for",2,2,function(a){var c=a[0],e=a[1];c.biwascheme_wait_for=c.biwascheme_wait_for||{};var d=c.biwascheme_wait_for[e];if(d){Event.stopObserving(c,e,d)}return new BiwaScheme.Pause(function(g){var f=function(h){c.biwascheme_wait_for[e]=undefined;Event.stopObserving(c,e,f);return g.resume(BiwaScheme.undef)};c.biwascheme_wait_for[e]=f;Event.observe(c,e,f)})});define_libfunc("domelem",1,null,function(a){throw new Error("obsolete")});define_libfunc("dom-remove-children!",1,1,function(a){BiwaScheme.Port.current_output.put_string("warning: dom-remove-children! is obsolete. use element-empty! instead");$(a[0]).update("");return BiwaScheme.undef});define_libfunc("dom-create-element",1,1,function(a){throw new Error("obsolete")});define_libfunc("element-append-child!",2,2,function(a){return $(a[0]).appendChild(a[1])});define_libfunc("dom-remove-child!",2,2,function(a){throw new Error("obsolete")});define_libfunc_raw("js-eval",1,1,function(ar){return eval(ar[0])});define_libfunc_raw("js-ref",2,2,function(a){assert_string(a[1]);return a[0][a[1]]});define_libfunc("js-set!",3,3,function(a){assert_string(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc_raw("js-call",1,null,function(a){var c=a.shift();assert_function(c);var d=null;return c.apply(d,a)});define_libfunc_raw("js-invoke",2,null,function(d){var c=d.shift();var a=d.shift();assert_string(a);if(c[a]){return c[a].apply(c,d)}else{throw new Error("js-invoke: function "+a+" is not defined")}});define_libfunc("js-new",1,null,function(ar,intp){var array_to_obj=function(ary){if((ary.length%2)!=0){throw new Error("js-new: odd number of key-value pair")}var obj={};for(var i=0;i<ary.length;i+=2){var key=ary[i],value=ary[i+1];assert_symbol(key);if(value.closure_p===true){value=BiwaScheme.js_closure(value,intp)}obj[key.name]=value}return obj};var ctor=ar.shift();assert_string(ctor);if(ar.length==0){return eval("new "+ctor+"()")}else{var args=[];for(var i=0;i<ar.length;i++){if(ar[i] instanceof Symbol){args.push(array_to_obj(ar.slice(i)));break}else{args.push(ar[i])}}var args_str=ar.map(function(value,i){return"args['"+i+"']"}).join(",");return eval("new "+ctor+"("+args_str+")")}});define_libfunc("js-obj",0,null,function(a){if(a.length%2!=0){throw new Error("js-obj: number of arguments must be even")}var c={};for(i=0;i<a.length/2;i++){assert_string(a[i*2]);c[a[i*2]]=a[i*2+1]}return c});BiwaScheme.js_closure=function(a,d){var c=d.on_error;return function(){var e=new Interpreter(c);e.invoke_closure(a,$A(arguments))}};define_libfunc("js-closure",1,1,function(c,a){assert_closure(c[0]);return BiwaScheme.js_closure(c[0],a)});define_libfunc("js-null?",1,1,function(a){return a[0]===null});define_libfunc("js-undefined?",1,1,function(a){return a[0]===undefined});define_libfunc("http-request",1,1,function(a){var c=a[0];assert_string(c);return new BiwaScheme.Pause(function(d){new Ajax.Request(c,{method:"get",onSuccess:function(e){d.resume(e.responseText)}})})});define_libfunc("http-post",2,2,function(a){var e=a[0];assert_string(e);var d=a[1];assert_list(d);var c={};d.foreach(function(f){assert_string(f.car);c[f.car]=f.cdr});return new BiwaScheme.Pause(function(f){new Ajax.Request(e,{method:"post",postBody:$H(c).toQueryString(),onSuccess:function(g){f.resume(g.responseText)}})})});BiwaScheme.jsonp_receiver=[];define_libfunc("receive-jsonp",1,1,function(a){var d=a[0];assert_string(d);var f=BiwaScheme.jsonp_receiver;for(var e=0;e<f.length;e++){if(f[e]===null){break}}var c=e;d+="?callback=BiwaScheme.jsonp_receiver["+c+"]";return new BiwaScheme.Pause(function(h){f[c]=function(j){h.resume(j);f[c]=null};var g=document.createElement("script");g.src=d;document.body.appendChild(g)})});define_libfunc("alert",1,1,function(a){alert(a[0]);return BiwaScheme.undef});define_libfunc("confirm",1,1,function(a){return confirm(a[0])});BiwaScheme.TupleSpaceClient=Class.create({initialize:function(a){this.server_path=a},nonblocking_request:function(a,c){var d=this.server_path+a+"?"+encodeURIComponent(to_write(c));return this.connect(d)},blocking_request:function(a,c){this.assert_init();var d=this.server_path+a+"?"+encodeURIComponent(to_write(c))+"&cid="+this.client_id;return new BiwaScheme.Pause(function(e){this.ajax(d,function(f){this.observe(f,function(g){e.resume(g)})}.bind(this))}.bind(this))},write:function(a){return this.nonblocking_request("write",a)},readp:function(a){return this.nonblocking_request("readp",a)},takep:function(a){return this.nonblocking_request("takep",a)},dump:function(){return this.nonblocking_request("dump","")},read:function(a){return this.blocking_request("read",a)},take:function(a){return this.blocking_request("take",a)},ajax:function(a,c){new Ajax.Request(a,{onSuccess:function(d){c(d.responseText)},onFailure:function(){BiwaScheme.Port.current_output.put_string("error: failed to access "+a)}})},init_connection:function(){if(this.client_id){return this.client_id}else{return new Pause(function(c){var a=this.server_path+"init_connection";this.ajax(a,function(d){this.client_id=d;this.start_connection();c.resume(this.client_id)}.bind(this))}.bind(this))}},assert_init:function(){if(!this.client_id){BiwaScheme.Port.current_output.put_string("ts-init not called:"+Object.inspect(this.client_id));throw new Error("ts-init not called")}},start_connection:function(){var c=this.server_path+"connection?cid="+this.client_id;var a=function(){this.ajax(c,function(g){var e=Interpreter.read(g);if(e){var f=e.car,d=e.cdr;this.notify(f,d);a()}}.bind(this))}.bind(this);a()},waiters:[],too_early_tuples:[],observe:function(a,c){if(this.too_early_tuples[a]){c(this.too_early_tuples[a]);this.too_early_tuples[a]=undefined}else{if(this.waiters[a]){BiwaScheme.Port.current_output.put_string("Bug: ticket conflicted")}else{this.waiters[a]=c}}},notify:function(c,a){var d=this.waiters[c];if(d){this.waiters[c]=undefined;return d(a)}else{this.too_early_tuples[c]=a}},connect:function(c,a){c+="&time="+(new Date()).getTime();return new BiwaScheme.Pause(function(d){new Ajax.Request(c,{method:"get",onSuccess:function(f){var e=f.responseText;if(a){e=a(e)}else{e=Interpreter.read(e)}if(e==undefined){d.resume(false)}else{d.resume(e)}},onFailure:function(e){throw new Error("ts_client.connect: failed to access"+c);d.resume(false)}})})}});BiwaScheme.ts_client=new TupleSpaceClient("/ts/");define_libfunc("ts-init",0,0,function(a){return ts_client.init_connection()});define_libfunc("ts-write",1,1,function(a){return ts_client.write(a[0])});define_libfunc("ts-read",1,1,function(a){var c=a[0];return ts_client.read(c)});define_libfunc("ts-readp",1,1,function(a){return ts_client.readp(a[0])});define_libfunc("ts-take",1,1,function(a){return ts_client.take(a[0])});define_libfunc("ts-takep",1,1,function(a){return ts_client.takep(a[0])});define_libfunc("ts-dump",0,0,function(a){return ts_client.dump()})}if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_libfunc("html-escape",1,1,function(a){assert_string(a[0]);return a[0].escapeHTML()});BiwaScheme.inspect_objs=function(a){return a.map(function(c){if(c.inspect){return c.inspect()}else{return Object.inspect($H(c))}}).join(", ")};define_libfunc("inspect",1,null,function(a){return BiwaScheme.inspect_objs(a)});define_libfunc("inspect!",1,null,function(a){BiwaScheme.Port.current_output.put_string(BiwaScheme.inspect_objs(a));return BiwaScheme.undef});BiwaScheme.json2sexp=function(c){switch(true){case Object.isNumber(c)||Object.isString(c)||c===true||c===false:return c;case Object.isArray(c):return c.map(function(d){return json2sexp(d)}).to_list();case typeof(c)=="object":var a=nil;for(key in c){a=new Pair(new Pair(key,json2sexp(c[key])),a)}return a;default:throw new Error("json->sexp: detected invalid value for json: "+Object.inspect(c))}throw new Bug("must not happen")};define_libfunc("json->sexp",1,1,function(a){return json2sexp(a[0])});define_libfunc("identity",1,1,function(a){return a[0]});define_libfunc("string-concat",1,1,function(a){assert_list(a[0]);return a[0].to_array().join("")});define_libfunc("string-split",2,2,function(a){assert_string(a[0]);assert_string(a[1]);return a[0].split(a[1]).to_list()});define_libfunc("string-join",1,2,function(a){assert_list(a[0]);var c="";if(a[1]){assert_string(a[1]);c=a[1]}return a[0].to_array().join(c)});define_libfunc("intersperse",2,2,function(c){var e=c[0],a=c[1];assert_list(a);var d=[];a.to_array().reverse().each(function(f){d.push(f);d.push(e)});d.pop();return d.to_list()});define_libfunc("map-with-index",2,null,function(d){var c=d.shift(),a=d;a.each(function(g){assert_list(g)});var f=[],e=0;return Call.multi_foreach(a,{call:function(h){var g=h.map(function(j){return j.car});g.unshift(e);e++;return new Call(c,g)},result:function(g){f.push(g)},finish:function(){return f.to_list()}})});var rearrange_args=function(d,f){var a=[];var e=(new Compiler).find_dot_pos(d);if(e==-1){a=f}else{for(var c=0;c<e;c++){a[c]=f[c]}a[c]=f.slice(c).to_list()}return a};define_syntax("define-macro",function(c){var h=c.cdr.car;var e;if(h instanceof Pair){var g=h.car;e=h.cdr;var a=c.cdr.cdr;var f=new Pair(Sym("lambda"),new Pair(e,a))}else{var g=h;var f=c.cdr.cdr.car;e=f.cdr.car}var j=Compiler.compile(f);if(j[1]!=0){throw new Bug("you cannot use free variables in macro expander (or define-macro must be on toplevel)")}var d=[j[2]];TopEnv[g.name]=new Syntax(g.name,function(p){var o=p.to_array();o.shift();var l=new Interpreter();var m=rearrange_args(e,o);var k=l.invoke_closure(d,m);return k});return BiwaScheme.undef});var macroexpand_1=function(c){if(c instanceof Pair){if(c.car instanceof Symbol&&TopEnv[c.car.name] instanceof Syntax){var a=TopEnv[c.car.name];c=a.transform(c)}else{throw new Error("macroexpand-1: `"+to_write_ss(c)+"' is not a macro")}}return c};define_syntax("%macroexpand",function(a){var c=(new Interpreter).expand(a.cdr.car);return[Sym("quote"),c].to_list()});define_syntax("%macroexpand-1",function(a){var c=macroexpand_1(a.cdr.car);return[Sym("quote"),c].to_list()});define_libfunc("macroexpand",1,1,function(a){return(new Interpreter).expand(a[0])});define_libfunc("macroexpand-1",1,1,function(a){return macroexpand_1(a[0])});define_libfunc("gensym",0,0,function(a){return BiwaScheme.gensym()});define_libfunc("print",1,null,function(a){a.map(function(c){BiwaScheme.Port.current_output.put_string(to_display(c),true)});BiwaScheme.Port.current_output.put_string("");return BiwaScheme.undef});define_libfunc("write-to-string",1,1,function(a){return to_write(a[0])});define_libfunc("read-from-string",1,1,function(a){assert_string(a[0]);return Interpreter.read(a[0])});define_libfunc("port-closed?",1,1,function(a){assert_port(a[0]);return !(a[0].is_open)});define_syntax("let1",function(c){var d=c.cdr.car;var e=c.cdr.cdr.car;var a=c.cdr.cdr.cdr;return new Pair(new Pair(Sym("lambda"),new Pair(new Pair(d,nil),a)),new Pair(e,nil))});var assert_regexp=function(a,c){if(!(a instanceof RegExp)){throw new Error(c+": regexp required, but got "+to_write(a))}};define_libfunc("string->regexp",1,1,function(a){assert_string(a[0],"string->regexp");return new RegExp(a[0])});define_libfunc("regexp?",1,1,function(a){return(a[0] instanceof RegExp)});define_libfunc("regexp->string",1,1,function(a){assert_regexp(a[0],"regexp->string");return a[0].toString().slice(1,-1)});define_libfunc("regexp-exec",2,2,function(a){var d=a[0];if(Object.isString(a[0])){d=new RegExp(a[0])}assert_regexp(d,"regexp-exec");assert_string(a[1],"regexp-exec");var c=d.exec(a[1]);return(c===null)?false:c.to_list()})}with(BiwaScheme){define_libfunc("iota",1,3,function(d){var g=d[0];var j=d[1]||0;var f=(d[2]===undefined)?1:d[2];assert_integer(g);assert_number(j);assert_number(f);var c=[],h=j;for(var e=0;e<g;e++){c.push(h);h+=f}return c.to_list()});define_libfunc("open-input-string",1,1,function(a){assert_string(a[0]);return new Port.StringInput(a[0])});define_libfunc("open-output-string",0,0,function(a){return new Port.StringOutput()});define_libfunc("get-output-string",1,1,function(a){assert_port(a[0]);if(!(a[0] instanceof Port.StringOutput)){throw new Error("get-output-string: port must be made by 'open-output-string'")}return a[0].output_string()});define_libfunc("current-date",0,1,function(a){return new Date()});define_libfunc("date?",1,1,function(a){return(a[0] instanceof Date)});define_libfunc("date-nanosecond",1,1,function(a){assert_date(a[0]);return a[0].getMilliseconds()*1000000});define_libfunc("date-millisecond",1,1,function(a){assert_date(a[0]);return a[0].getMilliseconds()});define_libfunc("date-second",1,1,function(a){assert_date(a[0]);return a[0].getSeconds()});define_libfunc("date-minute",1,1,function(a){assert_date(a[0]);return a[0].getMinutes()});define_libfunc("date-hour",1,1,function(a){assert_date(a[0]);return a[0].getHours()});define_libfunc("date-day",1,1,function(a){assert_date(a[0]);return a[0].getDate()});define_libfunc("date-month",1,1,function(a){assert_date(a[0]);return a[0].getMonth()+1});define_libfunc("date-year",1,1,function(a){assert_date(a[0]);return a[0].getFullYear()});define_libfunc("date-week-day",1,1,function(a){assert_date(a[0]);return a[0].getDay()});BiwaScheme.date_names={weekday:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],full_weekday:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],month:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],full_month:["January","February","March","April","May","June","July","August","September","Octorber","November","December"]};BiwaScheme.date2string=function(d,e){var f=function(g){return g<10?"0"+g:""+g};var c=function(g){return g<10?" "+g:""+g};var a={a:function(g){return date_names.weekday[g.getDay()]},A:function(g){return date_names.full_weekday[g.getDay()]},b:function(g){return date_names.month[g.getMonth()]},B:function(g){return date_names.full_month[g.getMonth()]},c:function(g){return g.toString()},d:function(g){return f(g.getDate())},D:function(g){return a.d(g)+a.m(g)+a.y(g)},e:function(g){return c(g.getDate())},f:function(g){return g.getSeconds()+g.getMilliseconds()/1000},h:function(g){return date_names.month[g.getMonth()]},H:function(g){return f(g.getHours())},I:function(g){var j=g.getHours();return f(j<13?j:j-12)},j:function(g){throw new Bug("not implemented: day of year")},k:function(g){return c(g.getHours())},l:function(g){var j=g.getHours();return c(j<13?j:j-12)},m:function(g){return f(g.getMonth())},M:function(g){return f(g.getMinutes())},n:function(g){return"\n"},N:function(g){throw new Bug("not implemented: nanoseconds")},p:function(g){return g.getHours()<13?"AM":"PM"},r:function(g){return a.I(g)+":"+a.M(g)+":"+a.S(g)+" "+a.p(g)},s:function(g){return Math.floor(g.getTime()/1000)},S:function(g){return f(g.getSeconds())},t:function(g){return"\t"},T:function(g){return a.H(g)+":"+a.M(g)+":"+a.S(g)},U:function(g){throw new Bug("not implemented: weeknum(0~, Sun)")},V:function(g){throw new Bug("not implemented: weeknum(1~, Sun?)")},w:function(g){return g.getDay()},W:function(g){throw new Bug("not implemented: weeknum(0~, Mon)")},x:function(g){throw new Bug("not implemented: weeknum(1~, Mon)")},X:function(g){return a.Y(g)+"/"+a.m(g)+"/"+a.d(g)},y:function(g){return g.getFullYear()%100},Y:function(g){return g.getFullYear()},z:function(g){throw new Bug("not implemented: time-zone")},Z:function(g){throw new Bug("not implemented: symbol time zone")},1:function(g){throw new Bug("not implemented: ISO-8601 year-month-day format")},2:function(g){throw new Bug("not implemented: ISO-8601 hour-minute-second-timezone format")},3:function(g){throw new Bug("not implemented: ISO-8601 hour-minute-second format")},4:function(g){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second-timezone format")},5:function(g){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second format")}};return e.replace(/~([\w1-5~])/g,function(h,g){var j=a[g];if(j){return j(d)}else{if(g=="~"){return"~"}else{return g}}})};define_libfunc("date->string",1,2,function(a){assert_date(a[0]);if(a[1]){assert_string(a[1]);return date2string(a[0],a[1])}else{return a[0].toString()}});define_libfunc("parse-date",1,1,function(a){assert_string(a[0]);return new Date(Date.parse(a[0]))});define_libfunc("random-integer",1,1,function(a){var c=a[0];assert_integer(c);if(c<0){throw new Error("random-integer: the argument must be >= 0")}else{return Math.floor(Math.random()*a[0])}});define_libfunc("random-real",0,0,function(a){return Math.random()});var user_write_ss=function(a){BiwaScheme.Port.current_output.put_string(write_ss(a[0]),true);return BiwaScheme.undef};define_libfunc("write/ss",1,2,user_write_ss);define_libfunc("write-with-shared-structure",1,2,user_write_ss);define_libfunc("write*",1,2,user_write_ss);define_libfunc("vector-append",2,null,function(a){var c=[];return c.concat.apply(c,a)})};